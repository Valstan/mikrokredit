# –°–∫—Ä–∏–ø—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è MikroKredit

## üìã –°–ø–∏—Å–æ–∫ —Å–∫—Ä–∏–ø—Ç–æ–≤

### –û—Å–Ω–æ–≤–Ω—ã–µ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–∏)

1. **start_service.sh** ‚≠ê
   - –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π health check
   ```bash
   ./start_service.sh
   ```

2. **stop_service.sh** ‚≠ê
   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
   ```bash
   ./stop_service.sh
   ```

3. **fix_sequences.sh** ‚≠ê
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ sequences PostgreSQL
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
   ```bash
   ./fix_sequences.sh
   ```
   **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
   - –û—à–∏–±–∫–∞ "duplicate key value violates unique constraint"
   - –ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
   - –ü–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ –±—ç–∫–∞–ø–∞
   - –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–π

4. **backup_to_yandex.sh** ‚≠ê –ù–û–í–´–ô!
   - –ë—ç–∫–∞–ø –ë–î –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2:00 MSK
   - –•—Ä–∞–Ω–∏—Ç 10 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∫–æ–ø–∏–π
   ```bash
   ./backup_to_yandex.sh
   ```

5. **download_from_yandex.sh** ‚≠ê –ù–û–í–´–ô!
   - –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤ —Å –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–∞
   - –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –±—ç–∫–∞–ø–æ–≤
   ```bash
   ./download_from_yandex.sh
   ./download_from_yandex.sh latest  # –°–∫–∞—á–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π
   ```

### –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ

4. **backup.sh**
   - –ë—ç–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
   ```bash
   ./backup.sh
   ```

5. **project.sh**
   - –û–±—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø—Ä–æ–µ–∫—Ç–æ–º
   ```bash
   ./project.sh
   ```

6. **postgres.sh**
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ PostgreSQL
   ```bash
   ./postgres.sh
   ```

7. **start.sh**
   - –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∑–∞–ø—É—Å–∫ (—Å—Ç–∞—Ä—ã–π)
   ```bash
   ./start.sh
   ```

## üîß –¢–∏–ø–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞
```bash
cd /home/valstan/mikrokredit
./start_service.sh
```

### –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
```bash
./stop_service.sh
./start_service.sh
# –∏–ª–∏
./stop_service.sh && ./start_service.sh
```

### –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–π–º–∞
```bash
# –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫—É: "duplicate key value violates unique constraint"
./fix_sequences.sh
# –ó–∞—Ç–µ–º –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–π–º —Å–Ω–æ–≤–∞
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
```bash
# –ü—Ä–æ—Ü–µ—Å—Å—ã
ps aux | grep gunicorn | grep mikrokredit

# Health check
curl http://localhost/healthz

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
export PGPASSWORD="mikrokredit_pass_2024"
psql -U mikrokredit_user -d mikrokredit -h localhost -c "SELECT COUNT(*) FROM loans;"
```

### –ü–æ–ª–Ω–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ
```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
./stop_service.sh

# 2. –ë—ç–∫–∞–ø
./backup.sh

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å sequences
./fix_sequences.sh

# 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å
./start_service.sh
```

## üõ†Ô∏è –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

### start_service.sh
**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç PostgreSQL
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –ó–∞–ø—É—Å–∫–∞–µ—Ç Gunicorn —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç health check
- –í—ã–≤–æ–¥–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö

**–í—ã—Ö–æ–¥–Ω–æ–π –∫–æ–¥:**
- 0 = —É—Å–ø–µ—à–Ω–æ
- 1 = –æ—à–∏–±–∫–∞ (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏)

**–õ–æ–≥–∏:**
- stdout: –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–ø—É—Å–∫–µ
- logs/error.log: –æ—à–∏–±–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- logs/access.log: –∑–∞–ø—Ä–æ—Å—ã –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é

### stop_service.sh
**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ò—â–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å—ã gunicorn
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç SIGTERM –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
- –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç SIGKILL

**–í—ã—Ö–æ–¥–Ω–æ–π –∫–æ–¥:**
- 0 = —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
- 1 = –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å

### fix_sequences.sh
**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ PostgreSQL
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç MAX(id) –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö
- –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ sequences
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–∏ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏
- –í—ã–≤–æ–¥–∏—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç

**–¢–∞–±–ª–∏—Ü—ã:**
- loans (–∑–∞–π–º—ã)
- installments (–ø–ª–∞—Ç–µ–∂–∏)

**–í—ã—Ö–æ–¥–Ω–æ–π –∫–æ–¥:**
- 0 = —É—Å–ø–µ—à–Ω–æ (–∏–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ —Ç—Ä–µ–±–æ–≤–∞–ª–æ—Å—å)
- 1 = –æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```
üîß –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è PostgreSQL sequences...
  –ü—Ä–æ–≤–µ—Ä–∫–∞ loans... ‚úÖ OK (–∑–Ω–∞—á–µ–Ω–∏–µ: 28)
  –ü—Ä–æ–≤–µ—Ä–∫–∞ installments... ‚úÖ OK (–∑–Ω–∞—á–µ–Ω–∏–µ: 64)
‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!

–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
  table_name  | max_id | sequence_value 
--------------+--------+----------------
 loans        |     28 |             29
 installments |     64 |             64
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ sequences
–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ cron –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏:

```bash
# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å crontab
crontab -e

# –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00):
0 3 * * * /home/valstan/mikrokredit/fix_sequences.sh >> /home/valstan/mikrokredit/logs/sequences.log 2>&1
```

### –õ–æ–≥–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
```bash
tail -50 logs/sequences.log
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏

### –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ sudo
–í—Å–µ —Å–∫—Ä–∏–ø—Ç—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –æ—Ç –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `valstan` –±–µ–∑ sudo.
–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç —è–≤–Ω–æ —Ç—Ä–µ–±—É–µ—Ç sudo (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è systemctl).

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
–°–∫—Ä–∏–ø—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
- `MIKROKREDIT_DATABASE_URL` - URL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- `PGPASSWORD` - –ø–∞—Ä–æ–ª—å –¥–ª—è psql (–≤—Ä–µ–º–µ–Ω–Ω–æ, —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ —Å–∫—Ä–∏–ø—Ç–∞)

### –ü—É—Ç–∏
–í—Å–µ —Å–∫—Ä–∏–ø—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞:
```bash
cd /home/valstan/mikrokredit
./–∏–º—è_—Å–∫—Ä–∏–ø—Ç–∞.sh
```

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –°–∫—Ä–∏–ø—Ç –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞
ls -l *.sh

# –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ:
chmod +x –∏–º—è_—Å–∫—Ä–∏–ø—Ç–∞.sh
```

### –û—à–∏–±–∫–∏ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å –≤—ã–≤–æ–¥–æ–º –æ—Ç–ª–∞–¥–∫–∏
bash -x ./–∏–º—è_—Å–∫—Ä–∏–ø—Ç–∞.sh

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
tail -50 logs/error.log
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å PostgreSQL
systemctl status postgresql

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
export PGPASSWORD="mikrokredit_pass_2024"
psql -U mikrokredit_user -d mikrokredit -h localhost -c "SELECT 1;"
```

## üìö –°–º. —Ç–∞–∫–∂–µ

- `QUICK_REFERENCE.md` - –±—ã—Å—Ç—Ä—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫
- `SEQUENCE_FIX_2025-10-09.md` - –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ sequences
- `STATUS_REPORT.md` - —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
- `FIXES_2025-10-09.md` - –∏—Å—Ç–æ—Ä–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

---
**–û–±–Ω–æ–≤–ª–µ–Ω–æ:** 09.10.2025  
**–°–∫—Ä–∏–ø—Ç–æ–≤:** 7 (3 –æ—Å–Ω–æ–≤–Ω—ã—Ö + 4 –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö)

