{% extends 'base.html' %}

{% block content %}
<div x-data="loanEditor({{ loan_json|safe }}, {{ installments_json|safe }})" x-init="init()">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0">
            <span x-show="!loanId">üí≥ –ù–æ–≤—ã–π –∑–∞–π–º</span>
            <span x-show="loanId">üí≥ –ó–∞–π–º #<span x-text="loanId"></span></span>
        </h4>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='/loans'">
                ‚Üê –ù–∞–∑–∞–¥
            </button>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
    <form @submit.prevent="saveLoan" class="needs-validation" novalidate>
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- –ë–∞–Ω–∫ -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">üè¶ –ë–∞–Ω–∫ / –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è *</label>
                        <input type="text" x-model="loan.org_name" class="form-control" required 
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∞–Ω–∏–ú–µ–Ω">
                    </div>

                    <!-- –°–∞–π—Ç -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">üåê –°–∞–π—Ç –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ *</label>
                        <div class="input-group">
                            <input type="text" x-model="loan.website" class="form-control" required 
                                   placeholder="https://example.com/lk">
                            <button type="button" class="btn btn-outline-secondary" 
                                    @click="window.open(loan.website, '_blank')" 
                                    :disabled="!loan.website">
                                –û—Ç–∫—Ä—ã—Ç—å
                            </button>
                        </div>
                    </div>

                    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
                    <div class="col-md-4">
                        <label class="form-label fw-bold">üè∑Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select x-model="loan.category" class="form-select">
                            <option value="microloan">üí∞ –ú–∏–∫—Ä–æ–∑–∞–π–º</option>
                            <option value="installment">üìä –†–∞—Å—Å—Ä–æ—á–∫–∞</option>
                            <option value="credit_card">üí≥ –ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞</option>
                        </select>
                    </div>

                    <!-- –î–∞—Ç–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è -->
                    <div class="col-md-4">
                        <label class="form-label fw-bold">üìÖ –î–∞—Ç–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è *</label>
                        <input type="date" x-model="loan.loan_date" class="form-control" required>
                    </div>

                    <!-- –°—É–º–º–∞ –≤–∑—è—Ç–∞ -->
                    <div class="col-md-4">
                        <label class="form-label fw-bold">üíµ –°—É–º–º–∞ –≤–∑—è—Ç–∞ *</label>
                        <input type="number" step="0.01" x-model.number="loan.amount_borrowed" 
                               class="form-control" required placeholder="0.00" 
                               @input="calculateTotals">
                    </div>

                    <!-- –¢–∏–ø –∑–∞–π–º–∞ -->
                    <div class="col-12">
                        <label class="form-label fw-bold">üìã –¢–∏–ø –∑–∞–π–º–∞</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" id="type-single" value="single" 
                                   x-model="loan.loan_type" @change="handleTypeChange">
                            <label class="btn btn-outline-primary" for="type-single">
                                üíµ –†–∞–∑–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂
                            </label>
                            
                            <input type="radio" class="btn-check" id="type-installment" value="installment" 
                                   x-model="loan.loan_type" @change="handleTypeChange">
                            <label class="btn btn-outline-primary" for="type-installment">
                                üìä –†–∞—Å—Å—Ä–æ—á–∫–∞ (–≥—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π)
                            </label>
                        </div>
                    </div>

                    <!-- –†–∞–∑–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂ -->
                    <template x-if="loan.loan_type === 'single'">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <strong>üíµ –†–∞–∑–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂:</strong> –í—Å—è —Å—É–º–º–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ–¥–Ω–∏–º –ø–ª–∞—Ç–µ–∂–æ–º
                            </div>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">üìÖ –î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ *</label>
                                    <input type="date" x-model="loan.due_date" class="form-control" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">üí∞ –°—É–º–º–∞ –∫ –≤–æ–∑–≤—Ä–∞—Ç—É *</label>
                                    <input type="number" step="0.01" x-model.number="loan.amount_due" 
                                           class="form-control" required @input="calculateTotals">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">üìà –ü–µ—Ä–µ–ø–ª–∞—Ç–∞</label>
                                    <div class="form-control-plaintext">
                                        <strong><span x-text="overpaymentAmount"></span> ‚ÇΩ</strong> 
                                        (<span x-text="overpaymentPercent"></span>%)
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞—Å—Å—Ä–æ—á–∫–∏) -->
        <template x-if="loan.loan_type === 'installment'">
            <div class="card shadow-sm mt-3">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üìä –ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π</h5>
                    <button type="button" class="btn btn-sm btn-light" @click="addInstallment">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç—ë–∂
                    </button>
                </div>
                <div class="card-body">
                    <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–ª–∞—Ç–µ–∂–µ–π -->
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50px">#</th>
                                    <th style="width: 180px">üìÖ –î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞</th>
                                    <th style="width: 150px" class="text-end">üí∞ –°—É–º–º–∞</th>
                                    <th style="width: 120px" class="text-center">‚úì –û–ø–ª–∞—á–µ–Ω</th>
                                    <th style="width: 150px">üìÖ –î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</th>
                                    <th style="width: 120px" class="text-end">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-if="installments.length === 0">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-4">
                                            üìã –î–æ–±–∞–≤—å—Ç–µ –ø–ª–∞—Ç–µ–∂–∏ –≤ –≥—Ä–∞—Ñ–∏–∫
                                        </td>
                                    </tr>
                                </template>
                                <template x-for="(inst, index) in installments" :key="index">
                                    <tr :class="{'table-success': inst.paid, 'table-warning': isUrgent(inst)}">
                                        <td><span x-text="index + 1"></span></td>
                                        <td>
                                            <input type="date" x-model="inst.due_date" 
                                                   class="form-control form-control-sm" required 
                                                   @change="calculateTotals">
                                        </td>
                                        <td>
                                            <input type="number" step="0.01" x-model.number="inst.amount" 
                                                   class="form-control form-control-sm text-end" required 
                                                   @input="calculateTotals">
                                        </td>
                                        <td class="text-center">
                                            <input type="checkbox" x-model="inst.paid" 
                                                   class="form-check-input" style="width: 1.5rem; height: 1.5rem;" 
                                                   @change="handlePaidChange(inst)">
                                        </td>
                                        <td>
                                            <input type="date" x-model="inst.paid_date" 
                                                   class="form-control form-control-sm" 
                                                   :disabled="!inst.paid">
                                        </td>
                                        <td class="text-end">
                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                    @click="removeInstallment(index)" 
                                                    title="–£–¥–∞–ª–∏—Ç—å">
                                                üóëÔ∏è
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                            <tfoot class="table-light fw-bold">
                                <tr>
                                    <td colspan="2" class="text-end">–ò–¢–û–ì–û:</td>
                                    <td class="text-end"><span x-text="formatMoney(totalInstallments)"></span> ‚ÇΩ</td>
                                    <td colspan="3">
                                        <span class="badge bg-danger me-2">–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ: <span x-text="formatMoney(unpaidAmount)"></span> ‚ÇΩ</span>
                                        <span class="badge bg-success">–û–ø–ª–∞—á–µ–Ω–æ: <span x-text="formatMoney(paidAmount)"></span> ‚ÇΩ</span>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- –°–≤–æ–¥–∫–∞ -->
                    <div class="row g-3 mt-2">
                        <div class="col-md-3">
                            <div class="border rounded p-3 text-center">
                                <div class="text-muted small">–í–∑—è—Ç–æ</div>
                                <div class="h5 mb-0"><span x-text="formatMoney(loan.amount_borrowed)"></span> ‚ÇΩ</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3 text-center">
                                <div class="text-muted small">–ö –≤–æ–∑–≤—Ä–∞—Ç—É</div>
                                <div class="h5 mb-0"><span x-text="formatMoney(totalInstallments)"></span> ‚ÇΩ</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3 text-center">
                                <div class="text-muted small">–ü–µ—Ä–µ–ø–ª–∞—Ç–∞</div>
                                <div class="h5 mb-0 text-danger">
                                    +<span x-text="formatMoney(overpaymentAmountNum)"></span> ‚ÇΩ 
                                    (<span x-text="overpaymentPercent"></span>%)
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3 text-center">
                                <div class="text-muted small">–°—Ä–µ–¥–Ω–∏–π –ø–ª–∞—Ç—ë–∂</div>
                                <div class="h5 mb-0"><span x-text="formatMoney(averagePayment)"></span> ‚ÇΩ</div>
                            </div>
                        </div>
                    </div>

                    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä -->
                    <div class="mt-3">
                        <label class="form-label small text-muted">–ü—Ä–æ–≥—Ä–µ—Å—Å –æ–ø–ª–∞—Ç—ã:</label>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 :style="`width: ${progressPercent}%`" 
                                 :aria-valuenow="progressPercent" 
                                 aria-valuemin="0" aria-valuemax="100">
                                <span x-text="`${progressPercent}%`"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="card shadow-sm mt-3">
            <div class="card-header">
                <h5 class="mb-0">üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- –†–∏—Å–∫–æ–≤–∞–Ω–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è -->
                    <div class="col-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="risky" 
                                   x-model="loan.risky_org">
                            <label class="form-check-label fw-bold" for="risky">
                                ‚ö†Ô∏è –†–∏—Å–∫–æ–≤–∞–Ω–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è (—Å–∫—Ä—ã—Ç—ã–µ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏/—É—Å–ª—É–≥–∏)
                            </label>
                        </div>
                    </div>

                    <!-- –ó–∞–º–µ—Ç–∫–∏ -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">üìã –ó–∞–º–µ—Ç–∫–∏</label>
                        <textarea x-model="loan.notes" class="form-control" rows="4" 
                                  placeholder="–õ—é–±–∞—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
                    </div>

                    <!-- –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">üí≥ –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã / –ö–æ–º–∏—Å—Å–∏–∏</label>
                        <textarea x-model="loan.payment_methods" class="form-control" rows="4" 
                                  placeholder="–°–ë–ü, –∫–∞—Ä—Ç–∞ (–∫–æ–º–∏—Å—Å–∏—è 5%), –∏ —Ç.–¥."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="d-flex gap-2 mt-4">
            <button type="submit" class="btn btn-primary btn-lg px-5" :disabled="saving">
                <span x-show="!saving">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
                <span x-show="saving">
                    <span class="spinner-border spinner-border-sm me-2"></span>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...
                </span>
            </button>
            
            <template x-if="loanId">
                <button type="button" class="btn btn-outline-danger" 
                        @click="deleteLoan" :disabled="deleting">
                    <span x-show="!deleting">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–π–º</span>
                    <span x-show="deleting">–£–¥–∞–ª–µ–Ω–∏–µ...</span>
                </button>
            </template>
            
            <button type="button" class="btn btn-outline-secondary" 
                    onclick="window.location.href='/loans'">
                ‚ùå –û—Ç–º–µ–Ω–∞
            </button>
        </div>
    </form>

</div>

<script>
function loanEditor(loanData, installmentsData) {
    return {
        loanId: loanData ? loanData.id : null,
        saving: false,
        deleting: false,
        loan: loanData || {
            org_name: '',
            website: '',
            loan_date: new Date().toISOString().split('T')[0],
            amount_borrowed: 0,
            amount_due: 0,
            due_date: '',
            risky_org: false,
            notes: '',
            payment_methods: '',
            loan_type: 'single',
            category: 'microloan',
            interest_rate: 0
        },
        installments: installmentsData || [],

        init() {
            console.log('Loan editor initialized', this.loanId, this.loan, this.installments);
            this.calculateTotals();
        },

        handleTypeChange() {
            if (this.loan.loan_type === 'single') {
                // –û—á–∏—â–∞–µ–º installments
                this.installments = [];
            } else {
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–π –ø–ª–∞—Ç—ë–∂ –µ—Å–ª–∏ –ø—É—Å—Ç–æ
                if (this.installments.length === 0) {
                    this.addInstallment();
                }
            }
            this.calculateTotals();
        },

        addInstallment() {
            this.installments.push({
                due_date: '',
                amount: 0,
                paid: false,
                paid_date: null,
                id: null
            });
        },

        removeInstallment(index) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–ª–∞—Ç—ë–∂?')) {
                this.installments.splice(index, 1);
                this.calculateTotals();
            }
        },

        handlePaidChange(inst) {
            if (inst.paid && !inst.paid_date) {
                inst.paid_date = new Date().toISOString().split('T')[0];
            } else if (!inst.paid) {
                inst.paid_date = null;
            }
            this.calculateTotals();
        },

        isUrgent(inst) {
            if (inst.paid) return false;
            const today = new Date();
            const dueDate = new Date(inst.due_date);
            const daysLeft = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
            return daysLeft >= 0 && daysLeft <= 5;
        },

        calculateTotals() {
            // –î–ª—è —Ä–∞—Å—Å—Ä–æ—á–∫–∏
            if (this.loan.loan_type === 'installment') {
                const total = this.installments.reduce((sum, inst) => sum + (parseFloat(inst.amount) || 0), 0);
                this.loan.amount_due = total;
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º due_date –∫–∞–∫ –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
                if (this.installments.length > 0) {
                    const sortedDates = this.installments
                        .map(i => i.due_date)
                        .filter(d => d)
                        .sort();
                    if (sortedDates.length > 0) {
                        this.loan.due_date = sortedDates[sortedDates.length - 1];
                    }
                }
            }
            
            // –†–∞—Å—á—ë—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–∞
            if (this.loan.amount_borrowed > 0) {
                this.loan.interest_rate = ((this.loan.amount_due - this.loan.amount_borrowed) / this.loan.amount_borrowed * 100).toFixed(2);
            }
        },

        get totalInstallments() {
            return this.installments.reduce((sum, inst) => sum + (parseFloat(inst.amount) || 0), 0);
        },

        get paidAmount() {
            return this.installments
                .filter(inst => inst.paid)
                .reduce((sum, inst) => sum + (parseFloat(inst.amount) || 0), 0);
        },

        get unpaidAmount() {
            return this.totalInstallments - this.paidAmount;
        },

        get averagePayment() {
            return this.installments.length > 0 ? this.totalInstallments / this.installments.length : 0;
        },

        get progressPercent() {
            return this.totalInstallments > 0 
                ? Math.round((this.paidAmount / this.totalInstallments) * 100) 
                : 0;
        },

        get overpaymentAmountNum() {
            return Math.max(0, (this.loan.amount_due || 0) - (this.loan.amount_borrowed || 0));
        },

        get overpaymentAmount() {
            return this.formatMoney(this.overpaymentAmountNum);
        },

        get overpaymentPercent() {
            return this.loan.amount_borrowed > 0 
                ? ((this.overpaymentAmountNum / this.loan.amount_borrowed) * 100).toFixed(2)
                : '0.00';
        },

        formatMoney(value) {
            return parseFloat(value || 0).toFixed(2);
        },

        async saveLoan() {
            this.saving = true;
            try {
                const data = {
                    ...this.loan,
                    installments: this.loan.loan_type === 'installment' ? this.installments : []
                };

                const url = this.loanId ? `/loan/${this.loanId}/save` : '/loan/new/save';
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.success) {
                    alert('‚úÖ –ó–∞–π–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
                    window.location.href = '/loans';
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
            } finally {
                this.saving = false;
            }
        },

        async deleteLoan() {
            if (!confirm('‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–π–º –∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
                return;
            }

            this.deleting = true;
            try {
                const response = await fetch(`/loan/${this.loanId}/delete`, {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    alert('‚úÖ –ó–∞–π–º —É–¥–∞–ª—ë–Ω!');
                    window.location.href = '/loans';
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            } finally {
                this.deleting = false;
            }
        }
    };
}
</script>

<style>
.modal.show { display: block; }
.form-check-input:checked { background-color: #28a745; border-color: #28a745; }
.table-warning { background-color: #fff3cd !important; }
</style>
{% endblock %}

