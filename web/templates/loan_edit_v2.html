{% extends 'base.html' %}

{% block content %}

<div x-data="loanEditor()" 
     data-loan='{{ loan_json|safe }}' 
     data-installments='{{ installments_json|safe }}' 
     x-init="init()">
    
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –±–∞–Ω–∫–∞ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">
            <span x-show="!loanId">üí≥ –ù–æ–≤—ã–π –∑–∞–π–º</span>
            <span x-show="loanId">üè¶ <span x-text="loan.org_name || '–ó–∞–π–º'"></span></span>
        </h3>
        <div>
            <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='/loans'">
                ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
            </button>
        </div>
    </div>

    <!-- –ì–ª–∞–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
    <form @submit.prevent="saveLoan">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="row g-3">
                    
                    <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞ -->
                    <div class="col-md-4">
                        <label class="form-label fw-bold">üè¶ –ë–∞–Ω–∫ *</label>
                        <input type="text" x-model="loan.org_name" class="form-control form-control-lg" 
                               required placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞">
                    </div>

                    <!-- –°—É–º–º–∞ –∫ –≤–æ–∑–≤—Ä–∞—Ç—É -->
                    <div class="col-md-4">
                        <label class="form-label fw-bold">üí∞ –ö –≤–æ–∑–≤—Ä–∞—Ç—É (–Ω–µ–æ–ø–ª–∞—á–µ–Ω–æ) *</label>
                        <div class="input-group input-group-lg">
                            <input type="number" step="0.01" x-model.number="unpaidAmount" 
                                   class="form-control text-end fw-bold text-danger" 
                                   readonly style="font-size: 1.5rem;">
                            <span class="input-group-text">‚ÇΩ</span>
                        </div>
                    </div>

                    <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ —Å–∞–π—Ç -->
                    <div class="col-md-4">
                        <label class="form-label fw-bold">üåê –°–∞–π—Ç –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ *</label>
                        <div class="input-group input-group-lg">
                            <input type="text" x-model="loan.website" class="form-control" required>
                            <button type="button" class="btn btn-outline-primary" 
                                    @click="window.open(loan.website, '_blank')" 
                                    :disabled="!loan.website">
                                –û—Ç–∫—Ä—ã—Ç—å
                            </button>
                        </div>
                    </div>

                    <!-- –ó–∞–º–µ—Ç–∫–∏ -->
                    <div class="col-12">
                        <label class="form-label fw-bold">üìù –ó–∞–º–µ—Ç–∫–∏</label>
                        <textarea x-model="loan.notes" class="form-control" rows="2" 
                                  placeholder="–õ—é–±–∞—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π -->
        <div class="card shadow-sm mt-3">
            <div class="card-header bg-gradient d-flex justify-content-between align-items-center" 
                 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="mb-0">üìÖ –ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π</h5>
                <button type="button" class="btn btn-light btn-sm" @click="addInstallment">
                    ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç—ë–∂
                </button>
            </div>
            <div class="card-body p-0">
                
                <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
                <div x-show="installments.length === 0" class="text-center py-5 text-muted">
                    <div style="font-size: 3rem;">üìã</div>
                    <p class="mb-3">–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π</p>
                    <button type="button" class="btn btn-primary" @click="addInstallment">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π –ø–ª–∞—Ç—ë–∂
                    </button>
                </div>

                <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–ª–∞—Ç–µ–∂–µ–π -->
                <table class="table table-hover mb-0" x-show="installments.length > 0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 50px" class="text-center">#</th>
                            <th style="width: 200px">üìÖ –î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞</th>
                            <th style="width: 180px" class="text-end">üí∞ –°—É–º–º–∞</th>
                            <th style="width: 100px" class="text-center">‚úì</th>
                            <th style="width: 150px">–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</th>
                            <th style="width: 80px"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(inst, index) in installments" :key="index">
                            <tr :class="{
                                'table-success': inst.paid,
                                'table-danger': !inst.paid && isOverdue(inst),
                                'table-warning': !inst.paid && isUrgent(inst) && !isOverdue(inst)
                            }">
                                <!-- –ù–æ–º–µ—Ä -->
                                <td class="text-center fw-bold">
                                    <span x-text="index + 1"></span>
                                </td>
                                
                                <!-- –î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞ -->
                                <td>
                                    <input type="date" x-model="inst.due_date" 
                                           class="form-control form-control-lg border-2" 
                                           required @change="calculateTotals"
                                           :class="{'border-danger': !inst.paid && isOverdue(inst), 'border-warning': !inst.paid && isUrgent(inst)}">
                                </td>
                                
                                <!-- –°—É–º–º–∞ -->
                                <td>
                                    <div class="input-group">
                                        <input type="number" step="0.01" x-model.number="inst.amount" 
                                               class="form-control form-control-lg text-end fw-bold border-2" 
                                               required @input="calculateTotals"
                                               :class="{'border-danger': !inst.paid && isOverdue(inst), 'border-warning': !inst.paid && isUrgent(inst)}"
                                               style="font-size: 1.2rem;">
                                        <span class="input-group-text">‚ÇΩ</span>
                                    </div>
                                </td>
                                
                                <!-- –ß–µ–∫–±–æ–∫—Å –æ–ø–ª–∞—Ç—ã -->
                                <td class="text-center">
                                    <input type="checkbox" x-model="inst.paid" 
                                           class="form-check-input" 
                                           style="width: 2rem; height: 2rem; cursor: pointer;" 
                                           @change="handlePaidChange(inst)">
                                </td>
                                
                                <!-- –î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã -->
                                <td>
                                    <input type="date" x-model="inst.paid_date" 
                                           class="form-control" 
                                           :disabled="!inst.paid">
                                </td>
                                
                                <!-- –£–¥–∞–ª–∏—Ç—å -->
                                <td class="text-end">
                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                            @click="removeInstallment(index)" title="–£–¥–∞–ª–∏—Ç—å">
                                        üóëÔ∏è
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                    
                    <!-- –ò—Ç–æ–≥–æ -->
                    <tfoot class="table-light" x-show="installments.length > 0">
                        <tr>
                            <td colspan="2" class="text-end fw-bold" style="font-size: 1.1rem;">–ò–¢–û–ì–û:</td>
                            <td class="text-end">
                                <div class="fw-bold" style="font-size: 1.3rem;">
                                    <span x-text="formatMoney(totalInstallments)"></span> ‚ÇΩ
                                </div>
                            </td>
                            <td colspan="3">
                                <div class="d-flex gap-2">
                                    <span class="badge bg-danger fs-6">
                                        –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ: <span x-text="formatMoney(unpaidAmount)"></span> ‚ÇΩ
                                    </span>
                                    <span class="badge bg-success fs-6">
                                        –û–ø–ª–∞—á–µ–Ω–æ: <span x-text="formatMoney(paidAmount)"></span> ‚ÇΩ
                                    </span>
                                </div>
                            </td>
                        </tr>
                    </tfoot>
                </table>

                <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä -->
                <div class="p-3" x-show="installments.length > 0">
                    <div class="d-flex justify-content-between mb-2">
                        <small class="text-muted">–ü—Ä–æ–≥—Ä–µ—Å—Å –æ–ø–ª–∞—Ç—ã:</small>
                        <small class="fw-bold">
                            <span x-text="paidCount"></span> –∏–∑ <span x-text="installments.length"></span> 
                            (<span x-text="progressPercent"></span>%)
                        </small>
                    </div>
                    <div class="progress" style="height: 30px;">
                        <div class="progress-bar bg-success" role="progressbar" 
                             :style="`width: ${progressPercent}%`" 
                             :aria-valuenow="progressPercent">
                            <strong><span x-text="progressPercent"></span>%</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="d-flex gap-2 mt-4">
            <button type="submit" class="btn btn-primary btn-lg px-5" :disabled="saving">
                <span x-show="!saving">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
                <span x-show="saving">
                    <span class="spinner-border spinner-border-sm me-2"></span>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...
                </span>
            </button>
            
            <template x-if="loanId">
                <button type="button" class="btn btn-outline-danger btn-lg" 
                        @click="deleteLoan" :disabled="deleting">
                    <span x-show="!deleting">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–π–º</span>
                    <span x-show="deleting">–£–¥–∞–ª–µ–Ω–∏–µ...</span>
                </button>
            </template>
            
            <button type="button" class="btn btn-outline-secondary btn-lg" 
                    onclick="window.location.href='/loans'">
                ‚ùå –û—Ç–º–µ–Ω–∞
            </button>
        </div>
    </form>
</div>

<script>
function loanEditor() {
    return {
        loanId: null,
        saving: false,
        deleting: false,
        loan: {
            org_name: '',
            website: '',
            amount_borrowed: 0,
            notes: ''
        },
        installments: [],

        init() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤
            const rootEl = this.$root;
            
            // Loan data
            const loanDataAttr = rootEl.getAttribute('data-loan');
            if (loanDataAttr && loanDataAttr !== 'null') {
                try {
                    const loanData = JSON.parse(loanDataAttr);
                    if (loanData) {
                        this.loan = {
                            org_name: loanData.org_name || '',
                            website: loanData.website || '',
                            amount_borrowed: loanData.amount_borrowed || 0,
                            notes: loanData.notes || ''
                        };
                        this.loanId = loanData.id;
                    }
                } catch (e) {
                    console.error('Error parsing loan data:', e);
                }
            }
            
            // Installments data
            const installmentsDataAttr = rootEl.getAttribute('data-installments');
            if (installmentsDataAttr) {
                try {
                    this.installments = JSON.parse(installmentsDataAttr);
                } catch (e) {
                    console.error('Error parsing installments data:', e);
                    this.installments = [];
                }
            }
            
            console.log('‚úÖ Loan loaded:', this.loan.org_name, 'Payments:', this.installments.length);
        },

        addInstallment() {
            this.installments.push({
                due_date: '',
                amount: 0,
                paid: false,
                paid_date: null,
                id: null
            });
        },

        removeInstallment(index) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–ª–∞—Ç—ë–∂?')) {
                this.installments.splice(index, 1);
            }
        },

        handlePaidChange(inst) {
            if (inst.paid && !inst.paid_date) {
                inst.paid_date = new Date().toISOString().split('T')[0];
            } else if (!inst.paid) {
                inst.paid_date = null;
            }
        },

        isOverdue(inst) {
            if (inst.paid) return false;
            const today = new Date();
            const dueDate = new Date(inst.due_date);
            return dueDate < today;
        },

        isUrgent(inst) {
            if (inst.paid) return false;
            const today = new Date();
            const dueDate = new Date(inst.due_date);
            const daysLeft = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
            return daysLeft >= 0 && daysLeft <= 5;
        },

        get totalInstallments() {
            return this.installments.reduce((sum, inst) => sum + (parseFloat(inst.amount) || 0), 0);
        },

        get paidAmount() {
            return this.installments
                .filter(inst => inst.paid)
                .reduce((sum, inst) => sum + (parseFloat(inst.amount) || 0), 0);
        },

        get unpaidAmount() {
            return this.totalInstallments - this.paidAmount;
        },

        get paidCount() {
            return this.installments.filter(inst => inst.paid).length;
        },

        get progressPercent() {
            return this.installments.length > 0 
                ? Math.round((this.paidCount / this.installments.length) * 100) 
                : 0;
        },

        formatMoney(value) {
            return parseFloat(value || 0).toLocaleString('ru-RU', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        },

        async saveLoan() {
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!this.loan.org_name || !this.loan.website) {
                alert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞ –∏ —Å–∞–π—Ç');
                return;
            }

            if (this.installments.length === 0) {
                alert('‚ùå –î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–ª–∞—Ç—ë–∂');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ –ø–ª–∞—Ç–µ–∂–µ–π
            for (let i = 0; i < this.installments.length; i++) {
                const inst = this.installments[i];
                if (!inst.due_date || !inst.amount || inst.amount <= 0) {
                    alert(`‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞—Ç—É –∏ —Å—É–º–º—É –¥–ª—è –ø–ª–∞—Ç–µ–∂–∞ #${i + 1}`);
                    return;
                }
            }

            this.saving = true;
            try {
                // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
                const data = {
                    org_name: this.loan.org_name,
                    website: this.loan.website,
                    amount_borrowed: this.loan.amount_borrowed,
                    notes: this.loan.notes,
                    // –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è
                    loan_date: new Date().toISOString().split('T')[0],
                    amount_due: this.totalInstallments,
                    due_date: this.installments.length > 0 
                        ? this.installments[this.installments.length - 1].due_date 
                        : new Date().toISOString().split('T')[0],
                    risky_org: false,
                    payment_methods: '',
                    loan_type: 'installment',
                    category: 'microloan',
                    interest_rate: 0,
                    installments: this.installments
                };

                const url = this.loanId ? `/loan/${this.loanId}/save` : '/loan/new/save';
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.success) {
                    alert('‚úÖ –ó–∞–π–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
                    window.location.href = '/loans';
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
            } finally {
                this.saving = false;
            }
        },

        async deleteLoan() {
            if (!confirm('‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–π–º –∏ –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
                return;
            }

            this.deleting = true;
            try {
                const response = await fetch(`/loan/${this.loanId}/delete`, {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    alert('‚úÖ –ó–∞–π–º —É–¥–∞–ª—ë–Ω!');
                    window.location.href = '/loans';
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            } finally {
                this.deleting = false;
            }
        }
    };
}
</script>

<style>
.table-danger { background-color: #f8d7da !important; }
.table-warning { background-color: #fff3cd !important; }
.table-success { background-color: #d1e7dd !important; }
.border-danger { border-color: #dc3545 !important; border-width: 2px !important; }
.border-warning { border-color: #ffc107 !important; border-width: 2px !important; }
</style>
{% endblock %}
