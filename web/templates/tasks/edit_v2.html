{% extends "base.html" %}

{% block title %}{% if task %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É{% else %}–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞{% endif %}{% endblock %}

{% block content %}

<div x-data="taskEditor()" 
     data-task='{{ task_json|safe }}' 
     data-schedules='{{ schedules_json|safe }}' 
     data-rules='{{ rules_json|safe }}'
     x-init="init()">
    
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">
            <i class="bi bi-check2-square"></i> 
            <span x-text="taskId ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É' : '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞'"></span>
        </h3>
        <a href="{{ url_for('tasks.index') }}" class="btn btn-outline-secondary">
            ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
        </a>
    </div>

    <form @submit.prevent="saveTask">
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-primary text-white">
                üìù –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
                    <div class="col-md-12">
                        <label class="form-label fw-bold">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ *</label>
                        <input type="text" x-model="task.title" class="form-control form-control-lg" 
                               required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –§—É—Ç–±–æ–ª - —Å—ã–Ω">
                    </div>

                    <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                    <div class="col-md-12">
                        <label class="form-label fw-bold">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea x-model="task.description" class="form-control" rows="2" 
                                  placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞—á–µ..."></textarea>
                    </div>

                    <!-- –í–∞–∂–Ω–æ—Å—Ç—å –∏ –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">–í–∞–∂–Ω–æ—Å—Ç—å *</label>
                        <select x-model.number="task.importance" class="form-select form-select-lg" required>
                            <option value="1">üî¥ –í–∞–∂–Ω–∞—è</option>
                            <option value="2">üü° –ù—É–∂–Ω–∞—è</option>
                            <option value="3">‚ö™ –•–æ—Ç–µ–ª–æ—Å—å –±—ã</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select x-model.number="task.category_id" class="form-select form-select-lg">
                            <option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                            <template x-for="cat in categories" :key="cat.id">
                                <option :value="cat.id" x-text="cat.name"></option>
                            </template>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- –¢–∏–ø –∑–∞–¥–∞—á–∏ -->
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-info text-white">
                ‚è∞ –¢–∏–ø –∑–∞–¥–∞—á–∏ –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
            </div>
            <div class="card-body">
                <!-- –í—ã–±–æ—Ä —Ç–∏–ø–∞ -->
                <div class="mb-3">
                    <label class="form-label fw-bold">–¢–∏–ø –∑–∞–¥–∞—á–∏</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" id="type-simple" value="simple" 
                               x-model="task.task_type" name="task_type">
                        <label class="btn btn-outline-primary" for="type-simple">
                            üìå –ü—Ä–æ—Å—Ç–∞—è –∑–∞–¥–∞—á–∞
                        </label>

                        <input type="radio" class="btn-check" id="type-event" value="event" 
                               x-model="task.task_type" name="task_type">
                        <label class="btn btn-outline-primary" for="type-event">
                            üìÖ –û–¥–∏–Ω–æ—á–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
                        </label>

                        <input type="radio" class="btn-check" id="type-recurring" value="recurring_event" 
                               x-model="task.task_type" name="task_type">
                        <label class="btn btn-outline-primary" for="type-recurring">
                            üîÅ –†–µ–≥—É–ª—è—Ä–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
                        </label>
                    </div>
                </div>

                <!-- –î–ª—è –ø—Ä–æ—Å—Ç–æ–π –∑–∞–¥–∞—á–∏ -->
                <div x-show="task.task_type === 'simple'" class="mb-3">
                    <label class="form-label fw-bold">–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                    <input type="datetime-local" x-model="task.due_date" class="form-control">
                    <small class="text-muted">–ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞—á—É</small>
                </div>

                <!-- –î–ª—è —Å–æ–±—ã—Ç–∏–π - —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏ -->
                <div x-show="task.task_type === 'event' || task.task_type === 'recurring_event'">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        –í—ã–±–µ—Ä–∏—Ç–µ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏ –∏ –≤—Ä–µ–º—è, –∫–æ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ
                    </div>

                    <!-- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ -->
                    <div class="border rounded p-3 bg-light">
                        <h6 class="mb-3">üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏:</h6>
                        
                        <template x-for="(day, index) in daysOfWeek" :key="index">
                            <div class="mb-3 pb-3" :class="{'border-bottom': index < 6}">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="form-check" style="min-width: 150px;">
                                        <input type="checkbox" 
                                               :id="'day-' + day.value" 
                                               class="form-check-input" 
                                               style="width: 1.5rem; height: 1.5rem;"
                                               :checked="hasScheduleForDay(day.value)"
                                               @change="toggleDay(day.value)">
                                        <label :for="'day-' + day.value" class="form-check-label ms-2 fs-5">
                                            <span x-text="day.label"></span>
                                        </label>
                                    </div>
                                    
                                    <template x-if="hasScheduleForDay(day.value)">
                                        <div class="flex-grow-1">
                                            <div class="input-group">
                                                <span class="input-group-text">–°</span>
                                                <input type="time" 
                                                       class="form-control"
                                                       :value="getScheduleForDay(day.value).start_time"
                                                       @input="updateScheduleTime(day.value, 'start_time', $event.target.value)">
                                                <span class="input-group-text">–î–æ</span>
                                                <input type="time" 
                                                       class="form-control"
                                                       :value="getScheduleForDay(day.value).end_time"
                                                       @input="updateScheduleTime(day.value, 'end_time', $event.target.value)">
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ -->
                    <div class="mt-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="pause-task" 
                                   x-model="task.is_paused">
                            <label class="form-check-label" for="pause-task">
                                ‚è∏Ô∏è –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –¥–∞—Ç—ã
                            </label>
                        </div>
                        <div x-show="task.is_paused" class="mt-2">
                            <input type="date" x-model="task.paused_until" class="form-control" 
                                   placeholder="–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–æ...">
                            <small class="text-muted">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–µ –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –¥–æ —ç—Ç–æ–π –¥–∞—Ç—ã</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∏–ª–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π -->
        <div class="card shadow-sm mb-3" x-show="task.task_type !== 'simple' || task.due_date">
            <div class="card-header bg-warning text-dark">
                üîî –ü—Ä–∞–≤–∏–ª–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
            </div>
            <div class="card-body">
                <div x-show="reminderRules.length === 0" class="text-center py-4 text-muted">
                    <p>–ü—Ä–∞–≤–∏–ª –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
                    <small>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ –Ω–∏–∂–µ</small>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–∞–≤–∏–ª -->
                <div class="list-group mb-3" x-show="reminderRules.length > 0">
                    <template x-for="(rule, index) in reminderRules" :key="index">
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-2">
                                        <span x-text="getRuleTypeLabel(rule.rule_type)"></span>
                                    </h6>
                                    <p class="mb-1 text-muted" x-text="getRuleDescription(rule)"></p>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-outline-primary" 
                                            @click="editRule(index)">
                                        –ò–∑–º–µ–Ω–∏—Ç—å
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                            @click="removeRule(index)">
                                        –£–¥–∞–ª–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ -->
                <div class="border rounded p-3" x-show="addingRule || editingRuleIndex !== null">
                    <h6 class="mb-3">
                        <span x-text="editingRuleIndex !== null ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ' : '–ù–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ'"></span>
                    </h6>

                    <!-- –¢–∏–ø –ø—Ä–∞–≤–∏–ª–∞ -->
                    <div class="mb-3">
                        <label class="form-label">–¢–∏–ø –ø—Ä–∞–≤–∏–ª–∞</label>
                        <select x-model="currentRule.rule_type" class="form-select">
                            <option value="before_start">‚è∞ –ó–∞ X –¥–æ –Ω–∞—á–∞–ª–∞</option>
                            <option value="before_end">‚è∞ –ó–∞ X –¥–æ –∫–æ–Ω—Ü–∞</option>
                            <option value="periodic_before">üîÅ –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –¥–æ –Ω–∞—á–∞–ª–∞</option>
                            <option value="periodic_during">üîÅ –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –≤–æ –≤—Ä–µ–º—è</option>
                            <option value="after_end">‚è∞ –ü–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è</option>
                        </select>
                    </div>

                    <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è before_start/before_end -->
                    <div x-show="currentRule.rule_type === 'before_start' || currentRule.rule_type === 'before_end'" class="mb-3">
                        <label class="form-label">–ó–∞ —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç</label>
                        <select x-model.number="currentRule.offset_minutes" class="form-select">
                            <option value="5">5 –º–∏–Ω—É—Ç</option>
                            <option value="10">10 –º–∏–Ω—É—Ç</option>
                            <option value="15">15 –º–∏–Ω—É—Ç</option>
                            <option value="20">20 –º–∏–Ω—É—Ç</option>
                            <option value="30">30 –º–∏–Ω—É—Ç</option>
                            <option value="60">1 —á–∞—Å</option>
                            <option value="120">2 —á–∞—Å–∞</option>
                            <option value="180">3 —á–∞—Å–∞</option>
                            <option value="240">4 —á–∞—Å–∞</option>
                            <option value="300">5 —á–∞—Å–æ–≤</option>
                            <option value="1440">1 –¥–µ–Ω—å</option>
                            <option value="2880">2 –¥–Ω—è</option>
                            <option value="4320">3 –¥–Ω—è</option>
                            <option value="7200">5 –¥–Ω–µ–π</option>
                            <option value="14400">10 –¥–Ω–µ–π</option>
                        </select>
                    </div>

                    <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è periodic_before -->
                    <div x-show="currentRule.rule_type === 'periodic_before'" class="mb-3">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">–ö–∞–∂–¥—ã–µ</label>
                                <select x-model.number="currentRule.interval_minutes" class="form-select">
                                    <option value="5">5 –º–∏–Ω—É—Ç</option>
                                    <option value="10">10 –º–∏–Ω—É—Ç</option>
                                    <option value="15">15 –º–∏–Ω—É—Ç</option>
                                    <option value="30">30 –º–∏–Ω—É—Ç</option>
                                    <option value="60">1 —á–∞—Å</option>
                                    <option value="120">2 —á–∞—Å–∞</option>
                                    <option value="180">3 —á–∞—Å–∞</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">–° (–≤—Ä–µ–º—è –∏–ª–∏ –º–∏–Ω—É—Ç—ã –¥–æ)</label>
                                <input type="text" x-model="currentRule.start_from" class="form-control" 
                                       placeholder="16:00 –∏–ª–∏ 240">
                                <small class="text-muted">–ù–∞–ø—Ä–∏–º–µ—Ä: 16:00 –∏–ª–∏ 240 (–º–∏–Ω)</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">–î–æ (–º–∏–Ω—É—Ç –¥–æ –Ω–∞—á–∞–ª–∞)</label>
                                <input type="number" x-model.number="currentRule.stop_at" class="form-control" 
                                       placeholder="30">
                                <small class="text-muted">30 = –∑–∞ 30 –º–∏–Ω –¥–æ –Ω–∞—á–∞–ª–∞</small>
                            </div>
                        </div>
                    </div>

                    <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è periodic_during -->
                    <div x-show="currentRule.rule_type === 'periodic_during'" class="mb-3">
                        <label class="form-label">–ö–∞–∂–¥—ã–µ</label>
                        <select x-model.number="currentRule.interval_minutes" class="form-select">
                            <option value="10">10 –º–∏–Ω—É—Ç</option>
                            <option value="15">15 –º–∏–Ω—É—Ç</option>
                            <option value="30">30 –º–∏–Ω—É—Ç</option>
                            <option value="60">1 —á–∞—Å</option>
                        </select>
                    </div>

                    <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è after_end -->
                    <div x-show="currentRule.rule_type === 'after_end'" class="mb-3">
                        <label class="form-label">–ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                        <select x-model.number="currentRule.offset_minutes" class="form-select">
                            <option value="5">5 –º–∏–Ω—É—Ç</option>
                            <option value="10">10 –º–∏–Ω—É—Ç</option>
                            <option value="15">15 –º–∏–Ω—É—Ç</option>
                            <option value="30">30 –º–∏–Ω—É—Ç</option>
                            <option value="60">1 —á–∞—Å</option>
                        </select>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∏ -->
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-success" @click="saveCurrentRule()">
                            <span x-text="editingRuleIndex !== null ? '–ü—Ä–∏–º–µ–Ω–∏—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å'"></span>
                        </button>
                        <button type="button" class="btn btn-secondary" @click="cancelRuleEdit()">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ -->
                <button type="button" class="btn btn-success" 
                        x-show="!addingRule && editingRuleIndex === null" 
                        @click="startAddingRule()">
                    ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
                </button>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
        <div class="d-flex gap-2 mt-4">
            <button type="submit" class="btn btn-primary btn-lg px-5" :disabled="saving">
                <span x-show="!saving">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
                <span x-show="saving">
                    <span class="spinner-border spinner-border-sm me-2"></span>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...
                </span>
            </button>
            
            <template x-if="taskId">
                <button type="button" class="btn btn-outline-danger btn-lg" 
                        @click="deleteTask" :disabled="deleting">
                    <span x-show="!deleting">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</span>
                    <span x-show="deleting">–£–¥–∞–ª–µ–Ω–∏–µ...</span>
                </button>
            </template>
            
            <a href="{{ url_for('tasks.index') }}" class="btn btn-outline-secondary btn-lg">
                ‚ùå –û—Ç–º–µ–Ω–∞
            </a>
        </div>
    </form>
</div>

<script>
function taskEditor() {
    return {
        taskId: null,
        saving: false,
        deleting: false,
        task: {
            title: '',
            description: '',
            importance: 2,
            category_id: null,
            task_type: 'simple',
            due_date: '',
            is_paused: false,
            paused_until: ''
        },
        schedules: [],
        reminderRules: [],
        categories: {{ categories_json|safe }},
        
        // UI —Å–æ—Å—Ç–æ—è–Ω–∏—è
        addingRule: false,
        editingRuleIndex: null,
        currentRule: this.getEmptyRule(),
        
        daysOfWeek: [
            { value: 1, label: '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫' },
            { value: 2, label: '–í—Ç–æ—Ä–Ω–∏–∫' },
            { value: 3, label: '–°—Ä–µ–¥–∞' },
            { value: 4, label: '–ß–µ—Ç–≤–µ—Ä–≥' },
            { value: 5, label: '–ü—è—Ç–Ω–∏—Ü–∞' },
            { value: 6, label: '–°—É–±–±–æ—Ç–∞' },
            { value: 7, label: '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ' }
        ],

        init() {
            const rootEl = this.$root;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á—É
            const taskData = rootEl.getAttribute('data-task');
            if (taskData && taskData !== 'null') {
                try {
                    const parsed = JSON.parse(taskData);
                    this.task = parsed;
                    this.taskId = parsed.id;
                } catch (e) {
                    console.error('Error parsing task:', e);
                }
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
            const schedulesData = rootEl.getAttribute('data-schedules');
            if (schedulesData && schedulesData !== 'null') {
                try {
                    this.schedules = JSON.parse(schedulesData);
                } catch (e) {
                    console.error('Error parsing schedules:', e);
                }
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∞–≤–∏–ª–∞
            const rulesData = rootEl.getAttribute('data-rules');
            if (rulesData && rulesData !== 'null') {
                try {
                    this.reminderRules = JSON.parse(rulesData);
                } catch (e) {
                    console.error('Error parsing rules:', e);
                }
            }
            
            console.log('‚úÖ Task editor initialized:', this.task.title || 'New task');
        },

        hasScheduleForDay(day) {
            return this.schedules.some(s => s.day_of_week === day);
        },

        getScheduleForDay(day) {
            return this.schedules.find(s => s.day_of_week === day) || {};
        },

        toggleDay(day) {
            const index = this.schedules.findIndex(s => s.day_of_week === day);
            if (index >= 0) {
                this.schedules.splice(index, 1);
            } else {
                this.schedules.push({
                    day_of_week: day,
                    start_time: '09:00',
                    end_time: '10:00',
                    is_active: true
                });
            }
        },

        updateScheduleTime(day, field, value) {
            const schedule = this.schedules.find(s => s.day_of_week === day);
            if (schedule) {
                schedule[field] = value;
            }
        },

        getEmptyRule() {
            return {
                rule_type: 'before_start',
                offset_minutes: 60,
                interval_minutes: 30,
                start_from: '',
                stop_at: '',
                is_active: true
            };
        },

        startAddingRule() {
            this.currentRule = this.getEmptyRule();
            this.addingRule = true;
        },

        editRule(index) {
            this.currentRule = { ...this.reminderRules[index] };
            this.editingRuleIndex = index;
            this.addingRule = false;
        },

        saveCurrentRule() {
            if (this.editingRuleIndex !== null) {
                this.reminderRules[this.editingRuleIndex] = { ...this.currentRule };
                this.editingRuleIndex = null;
            } else {
                this.reminderRules.push({ ...this.currentRule });
            }
            this.cancelRuleEdit();
        },

        cancelRuleEdit() {
            this.addingRule = false;
            this.editingRuleIndex = null;
            this.currentRule = this.getEmptyRule();
        },

        removeRule(index) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –ø—Ä–∞–≤–∏–ª–æ?')) {
                this.reminderRules.splice(index, 1);
            }
        },

        getRuleTypeLabel(type) {
            const labels = {
                'before_start': '‚è∞ –ó–∞ X –¥–æ –Ω–∞—á–∞–ª–∞',
                'before_end': '‚è∞ –ó–∞ X –¥–æ –∫–æ–Ω—Ü–∞',
                'periodic_before': 'üîÅ –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –¥–æ –Ω–∞—á–∞–ª–∞',
                'periodic_during': 'üîÅ –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –≤–æ –≤—Ä–µ–º—è',
                'after_end': '‚è∞ –ü–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è'
            };
            return labels[type] || type;
        },

        getRuleDescription(rule) {
            if (rule.rule_type === 'before_start' || rule.rule_type === 'before_end') {
                return `–ó–∞ ${rule.offset_minutes} –º–∏–Ω—É—Ç`;
            } else if (rule.rule_type === 'periodic_before') {
                return `–ö–∞–∂–¥—ã–µ ${rule.interval_minutes} –º–∏–Ω —Å ${rule.start_from} –¥–æ ${rule.stop_at} –º–∏–Ω –¥–æ –Ω–∞—á–∞–ª–∞`;
            } else if (rule.rule_type === 'periodic_during') {
                return `–ö–∞–∂–¥—ã–µ ${rule.interval_minutes} –º–∏–Ω—É—Ç –≤–æ –≤—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è`;
            } else if (rule.rule_type === 'after_end') {
                return `–ß–µ—Ä–µ–∑ ${rule.offset_minutes} –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è`;
            }
            return '';
        },

        async saveTask() {
            if (!this.task.title) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏');
                return;
            }

            this.saving = true;

            const data = {
                task: this.task,
                schedules: this.schedules,
                reminder_rules: this.reminderRules
            };

            try {
                const url = this.taskId 
                    ? `/tasks/${this.taskId}/edit/v2` 
                    : '/tasks/new/v2';
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    window.location.href = '/tasks';
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            } finally {
                this.saving = false;
            }
        },

        async deleteTask() {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?')) return;

            this.deleting = true;

            try {
                const response = await fetch(`/tasks/${this.taskId}/delete/v2`, {
                    method: 'POST'
                });

                if (response.ok) {
                    window.location.href = '/tasks';
                } else {
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            } finally {
                this.deleting = false;
            }
        }
    }
}
</script>

{% endblock %}

