{% extends "base.html" %}

{% block title %}{% if task_json != 'null' %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å{% else %}–ù–æ–≤–∞—è{% endif %} –∑–∞–¥–∞—á–∞{% endblock %}

{% block content %}

<div class="row justify-content-center">
    <div class="col-12 col-xl-10">
        <h2 class="mb-4">
            <i class="bi bi-check2-square"></i>
            {% if task_json != 'null' %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É{% else %}–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞{% endif %}
        </h2>

        <form id="taskForm">
            <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üìù –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label class="form-label fw-bold">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ *</label>
                            <input type="text" id="title" class="form-control form-control-lg" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–∏–µ–º –ª–µ–∫–∞—Ä—Å—Ç–≤">
                        </div>

                        <div class="col-md-12">
                            <label class="form-label fw-bold">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea id="description" class="form-control" rows="2"></textarea>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">–í–∞–∂–Ω–æ—Å—Ç—å *</label>
                            <select id="importance" class="form-select">
                                <option value="1">üî¥ –í–∞–∂–Ω–∞—è</option>
                                <option value="2" selected>üü° –ù—É–∂–Ω–∞—è</option>
                                <option value="3">‚ö™ –•–æ—Ç–µ–ª–æ—Å—å –±—ã</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                            <select id="category_id" class="form-select">
                                <option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">üìÖ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π</h5>
                </div>
                <div class="card-body">
                    
                    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–æ–≤ -->
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle"></i>
                        <strong>–†–µ–∂–∏–º –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç–∏:</strong> –í—ã–±–µ—Ä–∏—Ç–µ –ª–∏–±–æ –º–µ—Å—è—á–Ω—ã–π, –ª–∏–±–æ –Ω–µ–¥–µ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
                    </div>

                    <div class="btn-group w-100 mb-4" role="group">
                        <input type="radio" class="btn-check" id="mode-monthly" name="schedule_mode" value="monthly" checked>
                        <label class="btn btn-outline-primary btn-lg" for="mode-monthly" onclick="switchMode('monthly')">
                            üìÜ –ú–µ—Å—è—á–Ω—ã–π —Ä–µ–∂–∏–º
                        </label>

                        <input type="radio" class="btn-check" id="mode-weekly" name="schedule_mode" value="weekly">
                        <label class="btn btn-outline-primary btn-lg" for="mode-weekly" onclick="switchMode('weekly')">
                            üìÖ –ù–µ–¥–µ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
                        </label>
                    </div>

                    <!-- –ú–ï–°–Ø–ß–ù–´–ô –†–ï–ñ–ò–ú -->
                    <div id="monthly-mode">
                        <h6 class="mb-3">üìÜ –í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü—ã –∏ –¥–Ω–∏:</h6>
                        
                        <!-- –¢–∞–±–ª–∏—Ü–∞ –º–µ—Å—è—Ü–µ–≤ -->
                        <div class="mb-4">
                            <label class="fw-bold mb-2">–ú–µ—Å—è—Ü—ã:</label>
                            <div id="months-grid" class="d-grid gap-2" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                                <!-- JavaScript –∑–∞–ø–æ–ª–Ω–∏—Ç -->
                            </div>
                        </div>

                        <!-- –¢–∞–±–ª–∏—Ü–∞ –¥–Ω–µ–π –º–µ—Å—è—Ü–∞ -->
                        <div class="mb-4">
                            <label class="fw-bold mb-2">–î–Ω–∏ –º–µ—Å—è—Ü–∞:</label>
                            <div id="days-grid" class="d-grid gap-2" style="grid-template-columns: repeat(7, 1fr);">
                                <!-- JavaScript –∑–∞–ø–æ–ª–Ω–∏—Ç -->
                            </div>
                        </div>
                    </div>

                    <!-- –ù–ï–î–ï–õ–¨–ù–´–ô –†–ï–ñ–ò–ú -->
                    <div id="weekly-mode" style="display:none;">
                        <h6 class="mb-3">üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏:</h6>
                        <div id="weekdays-grid" class="d-grid gap-2" style="grid-template-columns: repeat(7, 1fr);">
                            <!-- JavaScript –∑–∞–ø–æ–ª–Ω–∏—Ç -->
                        </div>
                    </div>

                    <!-- –°–£–¢–û–ß–ù–´–ô –†–ï–ñ–ò–ú (–≤—Å–µ–≥–¥–∞ –∞–∫—Ç–∏–≤–µ–Ω) -->
                    <div class="mt-4">
                        <h6 class="mb-3">‚è∞ –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –≤ —Å—É—Ç–∫–∞—Ö (–∏–Ω—Ç–µ—Ä–≤–∞–ª 15 –º–∏–Ω—É—Ç):</h6>
                        <div class="mb-2 d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllTime()">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllTime()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
                            <button type="button" class="btn btn-sm btn-outline-info" onclick="selectWorkHours()">–†–∞–±–æ—á–∏–µ —á–∞—Å—ã (9-18)</button>
                        </div>
                        <div id="time-grid" class="d-grid gap-1" style="grid-template-columns: repeat(12, 1fr); font-size: 0.8rem;">
                            <!-- JavaScript –∑–∞–ø–æ–ª–Ω–∏—Ç -->
                        </div>
                    </div>

                    <!-- –°–≤–æ–¥–∫–∞ –≤—ã–±–æ—Ä–∞ -->
                    <div class="mt-4 p-3 bg-light rounded">
                        <h6>üìä –í—ã–±—Ä–∞–Ω–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ:</h6>
                        <div id="selection-summary" class="small">
                            <!-- JavaScript –∑–∞–ø–æ–ª–Ω–∏—Ç -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="d-flex gap-2 mt-4 flex-wrap">
                <button type="submit" class="btn btn-primary btn-lg px-4" id="saveBtn">
                    <i class="bi bi-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <a href="{{ url_for('tasks.index') }}" class="btn btn-outline-secondary btn-lg">
                    <i class="bi bi-x"></i> –û—Ç–º–µ–Ω–∞
                </a>
                <button type="button" class="btn btn-outline-danger btn-lg ms-auto" id="deleteBtn" style="display:none;">
                    <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// –î–∞–Ω–Ω—ã–µ –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞
const taskData = {{ task_json|safe }};
const categories = {{ categories_json|safe }};

// –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
let scheduleMode = 'monthly'; // 'monthly' –∏–ª–∏ 'weekly'
let selectedMonths = new Set(); // [1, 2, 3, ...] - –Ω–æ–º–µ—Ä–∞ –º–µ—Å—è—Ü–µ–≤
let selectedDays = new Set(); // [1, 2, 3, ..., 31] - –¥–Ω–∏ –º–µ—Å—è—Ü–∞
let selectedWeekdays = new Set(); // [1, 2, ..., 7] - –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏ (1=–ü–Ω)
let selectedTimes = new Set(); // ['09:00', '09:15', ...] - –≤—Ä–µ–º–µ–Ω–∞

const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', 
                    '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
const weekdayNames = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];

// === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===

function init() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞');
    
    fillBasicForm();
    renderMonthsGrid();
    renderDaysGrid();
    renderWeekdaysGrid();
    renderTimeGrid();
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –µ—Å—Ç—å
    loadScheduleFromData();
    
    updateSummary();
}

function fillBasicForm() {
    // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
    const catSelect = document.getElementById('category_id');
    categories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat.id;
        opt.textContent = cat.name;
        catSelect.appendChild(opt);
    });

    if (taskData) {
        document.getElementById('title').value = taskData.title || '';
        document.getElementById('description').value = taskData.description || '';
        document.getElementById('importance').value = taskData.importance || 2;
        document.getElementById('category_id').value = taskData.category_id || '';

        if (taskData.id) {
            document.getElementById('deleteBtn').style.display = 'inline-block';
        }
    }
}

function loadScheduleFromData() {
    if (!taskData || !taskData.schedule_config) {
        console.log('‚ö†Ô∏è –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è');
        return;
    }
    
    try {
        const config = JSON.parse(taskData.schedule_config);
        console.log('üìä –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ:', config);
        
        // –†–µ–∂–∏–º
        if (config.mode) {
            scheduleMode = config.mode;
            document.getElementById(`mode-${config.mode}`).checked = true;
            switchMode(config.mode);
        }
        
        // –ú–µ—Å—è—Ü—ã
        if (config.months && Array.isArray(config.months)) {
            config.months.forEach(m => selectedMonths.add(m));
            renderMonthsGrid();
        }
        
        // –î–Ω–∏ –º–µ—Å—è—Ü–∞
        if (config.days && Array.isArray(config.days)) {
            config.days.forEach(d => selectedDays.add(d));
            renderDaysGrid();
        }
        
        // –î–Ω–∏ –Ω–µ–¥–µ–ª–∏
        if (config.weekdays && Array.isArray(config.weekdays)) {
            config.weekdays.forEach(w => selectedWeekdays.add(w));
            renderWeekdaysGrid();
        }
        
        // –í—Ä–µ–º–µ–Ω–∞
        if (config.times && Array.isArray(config.times)) {
            config.times.forEach(t => selectedTimes.add(t));
            renderTimeGrid();
        }
        
        updateSummary();
        console.log('‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è:', error);
    }
}

// === –†–ï–ñ–ò–ú–´ ===

function switchMode(mode) {
    scheduleMode = mode;
    
    document.getElementById('monthly-mode').style.display = mode === 'monthly' ? 'block' : 'none';
    document.getElementById('weekly-mode').style.display = mode === 'weekly' ? 'block' : 'none';
    
    // –û—á–∏—â–∞–µ–º –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–π —Ä–µ–∂–∏–º
    if (mode === 'monthly') {
        selectedWeekdays.clear();
        renderWeekdaysGrid();
    } else {
        selectedMonths.clear();
        selectedDays.clear();
        renderMonthsGrid();
        renderDaysGrid();
    }
    
    updateSummary();
}

// === –ú–ï–°–Ø–¶–´ ===

function renderMonthsGrid() {
    const grid = document.getElementById('months-grid');
    grid.innerHTML = '';
    
    const today = new Date();
    const currentMonth = today.getMonth(); // 0-11
    
    // 6 –º–µ—Å—è—Ü–µ–≤ –≤–ø–µ—Ä–µ–¥
    for (let i = 0; i < 6; i++) {
        const monthIndex = (currentMonth + i) % 12;
        const monthNum = monthIndex + 1; // 1-12
        
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `btn ${selectedMonths.has(monthNum) ? 'btn-primary' : 'btn-outline-primary'}`;
        btn.textContent = monthNames[monthIndex];
        btn.onclick = () => toggleMonth(monthNum);
        
        grid.appendChild(btn);
    }
}

function toggleMonth(monthNum) {
    if (selectedMonths.has(monthNum)) {
        selectedMonths.delete(monthNum);
    } else {
        selectedMonths.add(monthNum);
    }
    renderMonthsGrid();
    updateSummary();
}

// === –î–ù–ò –ú–ï–°–Ø–¶–ê ===

function renderDaysGrid() {
    const grid = document.getElementById('days-grid');
    grid.innerHTML = '';
    
    for (let day = 1; day <= 31; day++) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `btn btn-sm ${selectedDays.has(day) ? 'btn-success' : 'btn-outline-secondary'}`;
        btn.textContent = day;
        btn.onclick = () => toggleDay(day);
        
        grid.appendChild(btn);
    }
}

function toggleDay(day) {
    if (selectedDays.has(day)) {
        selectedDays.delete(day);
    } else {
        selectedDays.add(day);
    }
    renderDaysGrid();
    updateSummary();
}

// === –î–ù–ò –ù–ï–î–ï–õ–ò ===

function renderWeekdaysGrid() {
    const grid = document.getElementById('weekdays-grid');
    grid.innerHTML = '';
    
    weekdayNames.forEach((name, index) => {
        const weekdayNum = index + 1; // 1=–ü–Ω
        
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `btn ${selectedWeekdays.has(weekdayNum) ? 'btn-info' : 'btn-outline-info'}`;
        btn.textContent = name;
        btn.onclick = () => toggleWeekday(weekdayNum);
        
        grid.appendChild(btn);
    });
}

function toggleWeekday(weekdayNum) {
    if (selectedWeekdays.has(weekdayNum)) {
        selectedWeekdays.delete(weekdayNum);
    } else {
        selectedWeekdays.add(weekdayNum);
    }
    renderWeekdaysGrid();
    updateSummary();
}

// === –í–†–ï–ú–Ø –í –°–£–¢–ö–ê–• ===

function renderTimeGrid() {
    const grid = document.getElementById('time-grid');
    grid.innerHTML = '';
    
    // 96 —è—á–µ–µ–∫ (24 —á–∞—Å–∞ √ó 4 = –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç)
    for (let hour = 0; hour < 24; hour++) {
        for (let min = 0; min < 60; min += 15) {
            const time = `${String(hour).padStart(2, '0')}:${String(min).padStart(2, '0')}`;
            
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = `btn btn-sm ${selectedTimes.has(time) ? 'btn-warning' : 'btn-outline-secondary'}`;
            btn.textContent = time;
            btn.title = time;
            btn.onclick = () => toggleTime(time);
            
            grid.appendChild(btn);
        }
    }
}

function toggleTime(time) {
    if (selectedTimes.has(time)) {
        selectedTimes.delete(time);
    } else {
        selectedTimes.add(time);
    }
    renderTimeGrid();
    updateSummary();
}

function selectAllTime() {
    for (let hour = 0; hour < 24; hour++) {
        for (let min = 0; min < 60; min += 15) {
            const time = `${String(hour).padStart(2, '0')}:${String(min).padStart(2, '0')}`;
            selectedTimes.add(time);
        }
    }
    renderTimeGrid();
    updateSummary();
}

function clearAllTime() {
    selectedTimes.clear();
    renderTimeGrid();
    updateSummary();
}

function selectWorkHours() {
    selectedTimes.clear();
    for (let hour = 9; hour < 18; hour++) {
        for (let min = 0; min < 60; min += 15) {
            const time = `${String(hour).padStart(2, '0')}:${String(min).padStart(2, '0')}`;
            selectedTimes.add(time);
        }
    }
    renderTimeGrid();
    updateSummary();
}

// === –°–í–û–î–ö–ê ===

function updateSummary() {
    const summary = document.getElementById('selection-summary');
    let html = '';
    
    if (scheduleMode === 'monthly') {
        if (selectedMonths.size > 0) {
            const months = Array.from(selectedMonths).sort((a, b) => a - b)
                .map(m => monthNames[m - 1]).join(', ');
            html += `<div><strong>–ú–µ—Å—è—Ü—ã:</strong> ${months}</div>`;
        } else {
            html += `<div class="text-muted">–ú–µ—Å—è—Ü—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</div>`;
        }
        
        if (selectedDays.size > 0) {
            const days = Array.from(selectedDays).sort((a, b) => a - b).join(', ');
            html += `<div><strong>–î–Ω–∏ –º–µ—Å—è—Ü–∞:</strong> ${days}</div>`;
        } else {
            html += `<div class="text-muted">–î–Ω–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</div>`;
        }
    } else {
        if (selectedWeekdays.size > 0) {
            const weekdays = Array.from(selectedWeekdays).sort((a, b) => a - b)
                .map(w => weekdayNames[w - 1]).join(', ');
            html += `<div><strong>–î–Ω–∏ –Ω–µ–¥–µ–ª–∏:</strong> ${weekdays}</div>`;
        } else {
            html += `<div class="text-muted">–î–Ω–∏ –Ω–µ–¥–µ–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</div>`;
        }
    }
    
    if (selectedTimes.size > 0) {
        const times = Array.from(selectedTimes).sort().slice(0, 10).join(', ');
        const more = selectedTimes.size > 10 ? ` –∏ –µ—â–µ ${selectedTimes.size - 10}` : '';
        html += `<div><strong>–í—Ä–µ–º—è:</strong> ${times}${more}</div>`;
    } else {
        html += `<div class="text-muted">–í—Ä–µ–º—è –Ω–µ –≤—ã–±—Ä–∞–Ω–æ</div>`;
    }
    
    // –ü–æ–¥—Å—á–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
    const count = calculateRemindersCount();
    html += `<div class="mt-2 text-primary"><strong>üìä –ü—Ä–∏–º–µ—Ä–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –≤ —Å—É—Ç–∫–∏: ${count}</strong></div>`;
    
    summary.innerHTML = html;
}

function calculateRemindersCount() {
    if (selectedTimes.size === 0) return 0;
    
    if (scheduleMode === 'monthly') {
        // –î–ª—è –º–µ—Å—è—á–Ω–æ–≥–æ: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Ä–µ–º—ë–Ω √ó –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π
        return selectedTimes.size * selectedDays.size;
    } else {
        // –î–ª—è –Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Ä–µ–º—ë–Ω √ó –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
        return selectedTimes.size * selectedWeekdays.size;
    }
}

// === –°–û–•–†–ê–ù–ï–ù–ò–ï ===

document.getElementById('taskForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    if (selectedTimes.size === 0) {
        alert('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –≤—Ä–µ–º—è –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π!');
        return;
    }

    if (scheduleMode === 'monthly' && (selectedMonths.size === 0 || selectedDays.size === 0)) {
        alert('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü—ã –∏ –¥–Ω–∏ –¥–ª—è –º–µ—Å—è—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞!');
        return;
    }

    if (scheduleMode === 'weekly' && selectedWeekdays.size === 0) {
        alert('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏ –¥–ª—è –Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞!');
        return;
    }

    const scheduleConfig = {
        mode: scheduleMode,
        months: Array.from(selectedMonths).sort(),
        days: Array.from(selectedDays).sort(),
        weekdays: Array.from(selectedWeekdays).sort(),
        times: Array.from(selectedTimes).sort()
    };

    const data = {
        task: {
            title: document.getElementById('title').value,
            description: document.getElementById('description').value,
            importance: parseInt(document.getElementById('importance').value),
            category_id: document.getElementById('category_id').value || null,
            task_type: 'calendar_reminder', // –ù–æ–≤—ã–π —Ç–∏–ø –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
            schedule_config: JSON.stringify(scheduleConfig)
        }
    };

    const url = taskData?.id ? `/tasks/${taskData.id}/edit` : '/tasks/new';

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok) {
            alert(`‚úÖ –ó–∞–¥–∞—á–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!\n\n–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ ~${calculateRemindersCount()} –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –≤ —Å—É—Ç–∫–∏`);
            window.location.href = '/tasks';
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
    }
});

// –£–¥–∞–ª–µ–Ω–∏–µ
document.getElementById('deleteBtn').addEventListener('click', async () => {
    if (!confirm('‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

    const btn = document.getElementById('deleteBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> –£–¥–∞–ª–µ–Ω–∏–µ...';

    try {
        const response = await fetch(`/tasks/${taskData.id}/delete`, {method: 'POST'});
        const result = await response.json();
        
        if (response.ok && result.success) {
            window.location.href = '/tasks';
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É';
        }
    } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É';
    }
});

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', init);
</script>

<style>
.d-grid button {
    padding: 0.5rem;
    transition: all 0.2s;
}

.d-grid button:hover {
    transform: scale(1.05);
}

#time-grid button {
    padding: 0.25rem;
    font-size: 0.7rem;
}
</style>

{% endblock %}

