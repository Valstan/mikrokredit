{% extends 'base.html' %}
{% block content %}
<h4>{{ 'Новый кредит' if not loan else 'Кредит #' ~ loan.id }}</h4>
<form method="post">
  <div class="row g-3">
    <div class="col-md-6">
      <label class="form-label">Банк</label>
      <input name="org_name" class="form-control" value="{{ loan.org_name if loan else '' }}" required>
    </div>
    <div class="col-md-6">
      <label class="form-label">Сайт</label>
      <input name="website" class="form-control" value="{{ loan.website if loan else '' }}" required>
    </div>
    <div class="col-md-6">
      <label class="form-label">Дата оформления</label>
      <input type="date" name="loan_date" class="form-control" value="{{ loan.loan_date if loan else '' }}" required>
    </div>
    <div class="col-md-6">
      <label class="form-label">Дата возврата</label>
      <input type="date" name="due_date" class="form-control" value="{{ loan.due_date if loan else '' }}" required>
    </div>
    <div class="col-md-6">
      <label class="form-label">Сумма взята</label>
      <input type="number" step="0.01" name="amount_borrowed" class="form-control" value="{{ loan.amount_borrowed if loan else '' }}" required>
    </div>
    {% if loan %}
    <div class="col-md-6">
      <label class="form-label">Сумма к возврату</label>
      <input type="number" class="form-control" value="{{ '%.2f'|format(remaining + 0) + '' if false else '%.2f'|format(total_due if total_due is defined else 0) }}" readonly>
    </div>
    {% endif %}
    <div class="col-md-6">
      <label class="form-label">Рискованная организация</label>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="risky_org" id="risk" {% if loan and loan.risky_org %}checked{% endif %}>
        <label class="form-check-label" for="risk">Скрытые страховки/услуги</label>
      </div>
    </div>
    <div class="col-12">
      <label class="form-label">Заметки</label>
      <textarea name="notes" class="form-control" rows="3">{{ loan.notes if loan else '' }}</textarea>
    </div>
    <div class="col-12">
      <label class="form-label">Способы/Комиссии</label>
      <textarea name="payment_methods" class="form-control" rows="3">{{ loan.payment_methods if loan else '' }}</textarea>
    </div>
  </div>
  <div class="mt-3 d-flex gap-2">
    <button class="btn btn-primary" type="submit">Сохранить</button>
    {% if loan %}
    <a class="btn btn-outline-danger" href="#" onclick="if(confirm('Удалить кредит?')){ document.getElementById('delete-form').submit(); } return false;">Удалить</a>
    {% endif %}
    {% if loan and loan.website %}
    <a class="btn btn-outline-secondary" href="{{ loan.website if loan.website.startswith('http') else 'https://' ~ loan.website }}" target="_blank">Открыть сайт</a>
    {% endif %}
  </div>
</form>

{% if loan %}
<form id="delete-form" method="post" action="/loan/{{ loan.id }}/delete" hx-post="/loan/{{ loan.id }}/delete" hx-target="main" hx-push-url="true"></form>
{% endif %}

{% if not loan %}
<div class="alert alert-info mt-3">Сохраните кредит, чтобы добавить график платежей.</div>
{% endif %}

{% if loan %}
<hr>
<h5>График платежей</h5>
<form class="row g-2" method="post" action="/loan/{{ loan.id }}/installments/add" hx-post="/loan/{{ loan.id }}/installments/add" hx-target="main">
  <div class="col-md-4">
    <input type="date" name="due_date" class="form-control" required>
  </div>
  <div class="col-md-4">
    <input type="number" step="0.01" name="amount" class="form-control" placeholder="Сумма" required>
  </div>
  <div class="col-md-4">
    <button class="btn btn-success" type="submit">Добавить платеж</button>
  </div>
</form>

<div class="table-responsive mt-3">
<table class="table table-sm align-middle">
  <thead>
    <tr>
      <th>Дата</th>
      <th class="text-end">Сумма</th>
      <th>Оплачен</th>
      <th>Дата оплаты</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for inst in installments %}
    <tr>
      <td>{{ inst.due_date }}</td>
      <td class="text-end">{{ '%.2f'|format(inst.amount) }}</td>
      <td>{{ 'Да' if inst.paid else 'Нет' }}</td>
      <td>{{ inst.paid_date or '' }}</td>
      <td>
        <form method="post" action="/loan/{{ loan.id }}/installments/{{ inst.id }}/edit" hx-post="/loan/{{ loan.id }}/installments/{{ inst.id }}/edit" hx-target="main" class="d-inline">
          <input type="date" name="due_date" value="{{ inst.due_date }}" class="form-control form-control-sm d-inline-block" style="width: 170px;">
          <input type="number" step="0.01" name="amount" value="{{ '%.2f'|format(inst.amount) }}" class="form-control form-control-sm d-inline-block text-end" style="width: 130px;">
          <button class="btn btn-sm btn-outline-success" type="submit">Изменить</button>
        </form>
        <form method="post" action="/loan/{{ loan.id }}/installments/{{ inst.id }}/toggle" hx-post="/loan/{{ loan.id }}/installments/{{ inst.id }}/toggle" hx-target="main" class="d-inline">
          <input type="hidden" name="paid" value="{{ 0 if inst.paid else 1 }}">
          <button class="btn btn-sm btn-outline-primary" type="submit">{{ 'Сделать не оплачен' if inst.paid else 'Оплачен' }}</button>
        </form>
        <form method="post" action="/loan/{{ loan.id }}/installments/{{ inst.id }}/toggle" hx-post="/loan/{{ loan.id }}/installments/{{ inst.id }}/toggle" hx-target="main" class="d-inline" x-on:submit="confirmDelete('Удалить платеж?')">
          <input type="hidden" name="action" value="delete">
          <button class="btn btn-sm btn-outline-danger" type="submit">Удалить</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>
<div class="mt-2 text-muted">Всего по графику: <b>{{ '%.2f'|format(total_due if total_due is defined else 0) }}</b> | Не оплачено: <b>{{ '%.2f'|format(remaining) }}</b></div>
{% endif %}
{% endblock %}
