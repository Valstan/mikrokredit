{% extends "base.html" %}

{% block title %}–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è - –ú–∏–∫—Ä–æ–ö—Ä–µ–¥–∏—Ç{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card mb-3">
            <div class="card-header">
                <h4><i class="bi bi-bell"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h4>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('profile.notifications') }}">
                    <input type="hidden" name="action" value="update_settings">
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="email_notifications" 
                               name="email_notifications" {% if user.email_notifications %}checked{% endif %}>
                        <label class="form-check-label" for="email_notifications">
                            <strong>Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</strong><br>
                            <small class="text-muted">–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–π–º–∞—Ö –∏ –∑–∞–¥–∞—á–∞—Ö –Ω–∞ email</small>
                        </label>
                    </div>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="telegram_notifications" 
                               name="telegram_notifications" {% if user.telegram_notifications %}checked{% endif %}>
                        <label class="form-check-label" for="telegram_notifications">
                            <strong>Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</strong><br>
                            <small class="text-muted">–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram –±–æ—Ç–µ</small>
                        </label>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    </button>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h4><i class="bi bi-telegram"></i> Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è</h4>
            </div>
            <div class="card-body">
                {% if user.telegram_chat_id %}
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> Telegram –ø–æ–¥–∫–ª—é—á–µ–Ω: <strong>{{ user.telegram_username or 'ID: ' + user.telegram_chat_id }}</strong>
                    </div>
                    
                    <form method="POST" action="{{ url_for('profile.notifications') }}">
                        <input type="hidden" name="action" value="unlink_telegram">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã?')">
                            <i class="bi bi-x-circle"></i> –û—Ç–∫–ª—é—á–∏—Ç—å Telegram
                        </button>
                    </form>
                {% else %}
                    {% set code = request.args.get('code') %}
                    
                    {% if code %}
                        <!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–¥ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ -->
                        <div class="alert alert-success">
                            <h5 class="alert-heading"><i class="bi bi-check-circle"></i> –ö–æ–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!</h5>
                            <hr>
                            <p class="mb-3">–í–∞—à –∫–æ–¥ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ Telegram:</p>
                            <div class="text-center my-3">
                                <h2 class="display-4 text-primary" id="linkCode">{{ code }}</h2>
                                <button class="btn btn-sm btn-outline-secondary" onclick="copyCode('{{ code }}')">
                                    <i class="bi bi-clipboard"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
                                </button>
                            </div>
                            <hr>
                            <p class="mb-2"><strong>–í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–±:</strong></p>
                            
                            <div class="d-grid gap-2">
                                <!-- –°–ø–æ—Å–æ–± 1: –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏) -->
                                <a href="https://t.me/valstan_bot?start={{ code }}" 
                                   target="_blank" 
                                   class="btn btn-lg btn-primary">
                                    <i class="bi bi-telegram"></i> –û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞ –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                                </a>
                                
                                <!-- –°–ø–æ—Å–æ–± 2: –í—Ä—É—á–Ω—É—é -->
                                <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#manualInstructions">
                                    <i class="bi bi-info-circle"></i> –ò–ª–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –≤—Ä—É—á–Ω—É—é
                                </button>
                            </div>
                            
                            <div class="collapse mt-3" id="manualInstructions">
                                <div class="card card-body">
                                    <h6>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</h6>
                                    <ol class="mb-0">
                                        <li>–û—Ç–∫—Ä–æ–π—Ç–µ Telegram</li>
                                        <li>–ù–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞: <a href="https://t.me/valstan_bot" target="_blank">@valstan_bot</a></li>
                                        <li>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É: <code>/start {{ code }}</code></li>
                                    </ol>
                                </div>
                            </div>
                            
                            <small class="text-muted mt-2 d-block">
                                <i class="bi bi-clock"></i> –ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 10 –º–∏–Ω—É—Ç
                            </small>
                        </div>
                    {% else %}
                        <!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Telegram –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω
                        </div>
                        
                        <h5>–ó–∞—á–µ–º –ø–æ–¥–∫–ª—é—á–∞—Ç—å Telegram?</h5>
                        <ul>
                            <li>üì± –ü–æ–ª—É—á–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–π–º–∞—Ö –ø—Ä—è–º–æ –≤ Telegram</li>
                            <li>‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –∑–∞–¥–∞—á–∞—Ö –∏ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö</li>
                            <li>üîî –ë—ã—Å—Ç—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</li>
                        </ul>
                        
                        <form method="POST" action="{{ url_for('profile.notifications') }}">
                            <input type="hidden" name="action" value="generate_code">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-telegram"></i> –ü–æ–¥–∫–ª—é—á–∏—Ç—å Telegram
                            </button>
                        </form>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function copyCode(code) {
    // –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–¥ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
    if (navigator.clipboard) {
        navigator.clipboard.writeText(code).then(function() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-success');
            
            setTimeout(function() {
                btn.innerHTML = originalHTML;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
            }, 2000);
        });
    } else {
        // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        const input = document.createElement('input');
        input.value = code;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        alert('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: ' + code);
    }
}
</script>
    </div>
</div>
{% endblock %}

