# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å PostgreSQL Sequences - 09.10.2025

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∫—Ä–µ–¥–∏—Ç–∞ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:
```
(psycopg2.errors.UniqueViolation) duplicate key value violates unique constraint "loans_pkey"
DETAIL: Key (id)=(2) already exists.
```

## –ü—Ä–∏—á–∏–Ω–∞

PostgreSQL sequences (—Å—á–µ—Ç—á–∏–∫–∏ –¥–ª—è –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞) –±—ã–ª–∏ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö:

### –ë—ã–ª–æ:
| –¢–∞–±–ª–∏—Ü–∞       | MAX(id) | Sequence | –ü—Ä–æ–±–ª–µ–º–∞ |
|---------------|---------|----------|----------|
| loans         | 28      | 2        | ‚ùå Sequence –æ—Ç—Å—Ç–∞—ë—Ç –Ω–∞ 26! |
| installments  | 64      | 1        | ‚ùå Sequence –æ—Ç—Å—Ç–∞—ë—Ç –Ω–∞ 63! |

Sequence –ø—ã—Ç–∞–ª—Å—è –≤—ã–¥–∞—Ç—å ID, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª –≤ —Ç–∞–±–ª–∏—Ü–µ, –≤—ã–∑—ã–≤–∞—è –æ—à–∏–±–∫—É —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∫–ª—é—á–∞.

## –†–µ—à–µ–Ω–∏–µ

–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã sequences —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º–∏ ID –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö:

```sql
-- –î–ª—è —Ç–∞–±–ª–∏—Ü—ã loans
SELECT setval('loans_id_seq', (SELECT MAX(id) FROM loans));

-- –î–ª—è —Ç–∞–±–ª–∏—Ü—ã installments  
SELECT setval('installments_id_seq', (SELECT MAX(id) FROM installments));
```

### –°—Ç–∞–ª–æ:
| –¢–∞–±–ª–∏—Ü–∞       | MAX(id) | Sequence | –°—Ç–∞—Ç—É—Å |
|---------------|---------|----------|--------|
| loans         | 29      | 29       | ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ |
| installments  | 64      | 64       | ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ |

## –ö–∞–∫ —ç—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ?

–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:
1. **–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö** - –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –±—ã–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã —Å —è–≤–Ω—ã–º–∏ ID –±–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è sequence
2. **–ü—Ä—è–º—ã–µ INSERT** - SQL –∫–æ–º–∞–Ω–¥—ã —Å —è–≤–Ω—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º ID
3. **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞** - –µ—Å–ª–∏ sequence –Ω–µ –±—ã–ª –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
4. **–ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** - –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –¥—Ä—É–≥–æ–π –ë–î

## –¢–µ—Å—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è –∑–∞–ø–∏—Å—å:
- ‚úÖ ID=29 —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –û—à–∏–±–∫–∞ –±–æ–ª—å—à–µ –Ω–µ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç
- ‚úÖ –ê–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

–°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `fix_sequences.sh` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```bash
./fix_sequences.sh
```

–°–∫—Ä–∏–ø—Ç:
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ sequences –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º–∏ ID –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –í—ã–≤–æ–¥–∏—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á—ë—Ç

### –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
```
üîß –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è PostgreSQL sequences...
  –ü—Ä–æ–≤–µ—Ä–∫–∞ loans... ‚úÖ OK (–∑–Ω–∞—á–µ–Ω–∏–µ: 29)
  –ü—Ä–æ–≤–µ—Ä–∫–∞ installments... ‚úÖ OK (–∑–Ω–∞—á–µ–Ω–∏–µ: 64)
‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –†–µ–≥—É–ª—è—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä—è—Ç—å sequences –ø–æ—Å–ª–µ:
- –ò–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ –±—ç–∫–∞–ø–∞
- –ú–∏–≥—Ä–∞—Ü–∏–π
- –ü—Ä—è–º—ã—Ö SQL –æ–ø–µ—Ä–∞—Ü–∏–π

```bash
cd /home/valstan/mikrokredit
./fix_sequences.sh
```

### 2. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
–ü—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö —Å —è–≤–Ω—ã–º–∏ ID –≤—Å–µ–≥–¥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π—Ç–µ sequences:

```sql
-- –ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ –≤ —Ç–∞–±–ª–∏—Ü—É loans
SELECT setval('loans_id_seq', (SELECT MAX(id) FROM loans), true);

-- –ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ –≤ —Ç–∞–±–ª–∏—Ü—É installments
SELECT setval('installments_id_seq', (SELECT MAX(id) FROM installments), true);
```

### 3. –ë—ç–∫–∞–ø—ã
–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—ç–∫–∞–ø–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–ª–∞–≥ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è sequences:

```bash
pg_dump -U mikrokredit_user -h localhost mikrokredit > backup.sql
# pg_dump –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç sequences
```

–ü—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ sequences –¥–æ–ª–∂–Ω—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

```bash
psql -U mikrokredit_user -h localhost mikrokredit < backup.sql
./fix_sequences.sh  # –ü—Ä–æ–≤–µ—Ä–∫–∞
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä—É—á–Ω—É—é

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã:
```sql
SELECT 
    'loans' as table_name,
    MAX(id) as max_id,
    (SELECT last_value FROM loans_id_seq) as seq_value,
    (SELECT is_called FROM loans_id_seq) as is_called
FROM loans;
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü:
```sql
SELECT 
    'loans' as table_name,
    COALESCE(MAX(id), 0) as max_id,
    (SELECT last_value FROM loans_id_seq) as sequence_value
FROM loans
UNION ALL
SELECT 
    'installments' as table_name,
    COALESCE(MAX(id), 0) as max_id,
    (SELECT last_value FROM installments_id_seq) as sequence_value
FROM installments;
```

### –†—É—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:
```bash
export PGPASSWORD="mikrokredit_pass_2024"

# Loans
psql -U mikrokredit_user -d mikrokredit -h localhost -c \
  "SELECT setval('loans_id_seq', COALESCE((SELECT MAX(id) FROM loans), 1), true);"

# Installments
psql -U mikrokredit_user -d mikrokredit -h localhost -c \
  "SELECT setval('installments_id_seq', COALESCE((SELECT MAX(id) FROM installments), 1), true);"
```

## –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

–°–∫—Ä–∏–ø—Ç `fix_sequences.sh` –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ç:
```
/home/valstan/mikrokredit/
  ‚îú‚îÄ start_service.sh         # –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  ‚îú‚îÄ stop_service.sh          # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  ‚îî‚îÄ fix_sequences.sh         # ‚≠ê –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è sequences (–ù–û–í–´–ô)
```

## –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≤ –±—É–¥—É—â–µ–º

### –í –∫–æ–¥–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
SQLAlchemy –º–æ–¥–µ–ª—å —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
```python
id: Mapped[int] = mapped_column(
    Integer, 
    Sequence('loans_id_seq'),  # –Ø–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ sequence
    primary_key=True, 
    autoincrement=True         # –ê–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç
)
```

### –ü—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏—è—Ö
–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏–∏ (Alembic), –≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É sequences:
```python
# –í –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
op.execute("SELECT setval('loans_id_seq', (SELECT MAX(id) FROM loans), true);")
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤ cron –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:
```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ crontab (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00)
0 3 * * * /home/valstan/mikrokredit/fix_sequences.sh >> /home/valstan/mikrokredit/logs/sequences.log 2>&1
```

## –ò—Ç–æ–≥

‚úÖ **–ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞**
- Sequences —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç
- –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞

üîß **–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –±—É–¥—É—â–µ–º:**
```bash
./fix_sequences.sh
```

---
**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 09.10.2025 08:45 MSK  
**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ç–∞–±–ª–∏—Ü—ã:** loans, installments  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

