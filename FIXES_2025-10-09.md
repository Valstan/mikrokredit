# Исправления проекта MikroKredit - 09.10.2025

## Проблема
Internal Server Error при обращении к приложению:
- `SSL SYSCALL error: EOF detected` при работе с PostgreSQL
- Несоответствие конфигураций (пути, пароли, порты)
- Приложение работало нестабильно

## Выполненные исправления

### 1. Конфигурация базы данных (`app/config.py`)
**Было:** `mikrokredit_pass@localhost:5432/mikrokredit`
**Стало:** `mikrokredit_pass_2024@localhost:5432/mikrokredit`

- Исправлен пароль для подключения к PostgreSQL
- Теперь используется правильная БД `mikrokredit` (с 26 записями)

### 2. Настройки SQLAlchemy (`app/db_sa.py`)
**Добавлено:**
```python
pool_size=10,              # Размер пула подключений
max_overflow=20,           # Дополнительные подключения при нагрузке
pool_pre_ping=True,        # Проверка подключения перед использованием
pool_recycle=3600,         # Переиспользование подключений каждый час
```

**Решает:** 
- Проблему с разрывом SSL соединений
- Утечку подключений
- Повышает стабильность работы с БД

### 3. Конфигурация Gunicorn (`gunicorn.conf.py`)
**Было:** 
- `/home/valstan/development/mikrokredit/logs/`
- `MIKROKREDIT_USE_SQLITE=1`

**Стало:**
- `/home/valstan/mikrokredit/logs/`
- SQLite отключен (используется PostgreSQL)

### 4. Systemd сервис (`mikrokredit.service`)
**Было:**
```
WorkingDirectory=/home/valstan/development/mikrokredit
Environment=...@localhost:5434/mikrokredit_db
Type=simple
```

**Стало:**
```
WorkingDirectory=/home/valstan/mikrokredit
Environment=...@localhost:5432/mikrokredit
Type=notify
ExecStart=gunicorn --config ...
```

### 5. Nginx конфигурация (`nginx.conf`)
**Было:** `/home/valstan/development/mikrokredit/web/static`
**Стало:** `/home/valstan/mikrokredit/web/static`

### 6. Новые скрипты управления
Созданы скрипты для управления сервисом:

**`start_service.sh`:**
- Останавливает старые процессы
- Проверяет PostgreSQL
- Запускает Gunicorn с правильными настройками
- Проверяет health check

**`stop_service.sh`:**
- Корректная остановка всех процессов
- Проверка завершения

## Текущее состояние

✅ **Приложение запущено и работает стабильно**
- Порт: 8002
- Воркеры: 4 (включая master)
- База данных: PostgreSQL (mikrokredit, 26 записей)
- Health check: OK (http://127.0.0.1:8002/healthz)
- Nginx proxy: активен
- Тестовые запросы: 5/5 успешно (HTTP 200)

## Использование

### Запуск сервиса:
```bash
cd /home/valstan/mikrokredit
./start_service.sh
```

### Остановка сервиса:
```bash
cd /home/valstan/mikrokredit
./stop_service.sh
```

### Проверка статуса:
```bash
ps aux | grep gunicorn | grep mikrokredit
curl http://127.0.0.1:8002/healthz
curl -I http://localhost/
```

### Логи:
```bash
# Логи приложения
tail -f /home/valstan/mikrokredit/logs/error.log
tail -f /home/valstan/mikrokredit/logs/access.log

# Логи Nginx
tail -f /var/log/nginx/mikrokredit_access.log
tail -f /var/log/nginx/mikrokredit_error.log
```

## Конфигурация БД
- **Хост:** localhost:5432
- **База:** mikrokredit
- **Пользователь:** mikrokredit_user
- **Пароль:** mikrokredit_pass_2024
- **Записи:** 26 loans

## Примечания
1. Файл `mikrokredit.service` обновлён, но требует sudo для установки в systemd
2. Сервис сейчас запускается через скрипты вручную
3. Все пути исправлены с `/home/valstan/development/mikrokredit` на `/home/valstan/mikrokredit`
4. PostgreSQL работает стабильно с новыми настройками пула подключений

