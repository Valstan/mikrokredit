# 🗓️ Дизайн системы гибких напоминаний для задач

## 📊 Структура БД

### 1. **tasks** (расширение существующей таблицы)
Добавляем новые поля:
```sql
-- Тип задачи
task_type VARCHAR(50) DEFAULT 'simple'  -- simple, event, recurring_event

-- Для событий с длительностью
has_duration BOOLEAN DEFAULT FALSE
duration_minutes INTEGER  -- Длительность в минутах

-- Приостановка
is_paused BOOLEAN DEFAULT FALSE
paused_until DATE  -- До какой даты приостановлено
```

### 2. **task_schedules** (новая таблица)
Расписание для задачи (когда она происходит):
```sql
CREATE TABLE task_schedules (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id INTEGER NOT NULL,
    
    -- День недели (1=Пн, 2=Вт, ..., 7=Вс)
    day_of_week INTEGER NOT NULL,
    
    -- Время начала (HH:MM)
    start_time TEXT NOT NULL,
    
    -- Время окончания (HH:MM) - для событий с длительностью
    end_time TEXT,
    
    -- Активно ли это расписание
    is_active BOOLEAN DEFAULT TRUE,
    
    created_at TEXT NOT NULL,
    
    FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE
);
```

### 3. **reminder_rules** (новая таблица)
Правила напоминаний для задачи:
```sql
CREATE TABLE reminder_rules (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id INTEGER NOT NULL,
    
    -- Тип правила
    -- 'before_start' - За X до начала (одноразово)
    -- 'before_end' - За X до конца (одноразово)
    -- 'periodic_before' - Периодически до начала
    -- 'periodic_during' - Периодически во время события
    -- 'after_end' - После окончания
    rule_type TEXT NOT NULL,
    
    -- Для before_start/before_end: минуты до события
    offset_minutes INTEGER,
    
    -- Для periodic: интервал в минутах
    interval_minutes INTEGER,
    
    -- Для periodic_before: с какого времени начинать (HH:MM или минуты до начала)
    start_from TEXT,
    
    -- Для periodic_before: до какого времени (обычно до начала события)
    stop_at TEXT,
    
    -- Активно ли правило
    is_active BOOLEAN DEFAULT TRUE,
    
    -- Порядок отображения
    order_index INTEGER DEFAULT 0,
    
    created_at TEXT NOT NULL,
    
    FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE
);
```

### 4. **task_reminders** (расширение существующей)
Сгенерированные напоминания (остается как есть, но будет заполняться автоматически по правилам).

---

## 🎯 Примеры использования

### Пример 1: Футбол (из ТЗ)
```
Task:
  title = "Футбол - сын"
  task_type = "recurring_event"
  is_recurring = TRUE
  recurrence_rule = "weekly"  -- Еженедельно

Schedules:
  1. day_of_week=1 (Пн), start_time="20:00", end_time="21:00"
  2. day_of_week=3 (Ср), start_time="20:00", end_time="21:00"
  3. day_of_week=5 (Пт), start_time="21:00", end_time="22:00"

Reminder Rules:
  1. rule_type="periodic_before"
     interval_minutes=30
     start_from="16:00"
     stop_at="30 minutes before start"
     
  2. rule_type="before_end"
     offset_minutes=20
```

Результат: 
- Пн: напоминания в 16:00, 16:30, 17:00, 17:30, 18:00, 18:30, 19:00, 19:30, 20:40
- Ср: напоминания в 16:00, 16:30, 17:00, 17:30, 18:00, 18:30, 19:00, 19:30, 20:40
- Пт: напоминания в 16:00, 16:30, 17:00, 17:30, 18:00, 18:30, 19:00, 19:30, 20:00, 20:30, 21:40

### Пример 2: Простая задача с дедлайном
```
Task:
  title = "Оплатить интернет"
  task_type = "simple"
  due_date = "2025-10-15"

Reminder Rules:
  1. rule_type="before_start", offset_minutes=1440  -- За 1 день
  2. rule_type="before_start", offset_minutes=60    -- За 1 час
```

---

## 🏗️ Архитектура компонентов

### 1. **ReminderGenerator** (новый сервис)
Генерирует конкретные напоминания из правил:
- Вызывается при создании/изменении задачи
- Создает записи в `task_reminders` на ближайшую неделю/месяц
- Периодически обновляет расписание (раз в день)

### 2. **TaskScheduler** (обновленный)
- Проверяет `task_reminders` каждую минуту
- Отправляет непрошенные напоминания через Telegram

### 3. **UI Components**
- `ScheduleEditor` - редактор расписания по дням недели
- `ReminderRulesEditor` - редактор правил напоминаний
- `TaskFormV2` - новая форма создания/редактирования задач

---

## 📱 UI Макет

```
┌─────────────────────────────────────────────────────────┐
│ 📋 Задача: Футбол - сын                                │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ 📝 Описание:                                            │
│ [Тренировки по футболу                            ]     │
│                                                          │
│ 🎯 Важность: ● Важная  ○ Нужная  ○ Хотелось бы        │
│                                                          │
│ ⏰ Тип: ○ Простая задача  ● Событие с расписанием     │
│                                                          │
│ ┌─────────────────────────────────────────────────┐    │
│ │ 📅 Расписание по дням недели:                   │    │
│ │                                                  │    │
│ │ ☑ Понедельник    20:00 - 21:00  [Изменить]     │    │
│ │ ☐ Вторник                                       │    │
│ │ ☑ Среда          20:00 - 21:00  [Изменить]     │    │
│ │ ☐ Четверг                                       │    │
│ │ ☑ Пятница        21:00 - 22:00  [Изменить]     │    │
│ │ ☐ Суббота                                       │    │
│ │ ☐ Воскресенье                                   │    │
│ └─────────────────────────────────────────────────┘    │
│                                                          │
│ ┌─────────────────────────────────────────────────┐    │
│ │ 🔔 Правила напоминаний:                         │    │
│ │                                                  │    │
│ │ 1. ⏰ Периодические до начала                   │    │
│ │    ├─ Каждые: [30 ▼] минут                     │    │
│ │    ├─ От: [16:00] (фиксированное время)        │    │
│ │    └─ До: [30 ▼] минут до начала               │    │
│ │    [Изменить] [Удалить]                         │    │
│ │                                                  │    │
│ │ 2. ⏰ Перед концом события                      │    │
│ │    └─ За: [20 ▼] минут до конца                │    │
│ │    [Изменить] [Удалить]                         │    │
│ │                                                  │    │
│ │ [+ Добавить правило ▼]                          │    │
│ │    • За X до начала                             │    │
│ │    • За X до конца                              │    │
│ │    • Периодически до начала                     │    │
│ │    • Периодически во время                      │    │
│ │    • После окончания                            │    │
│ └─────────────────────────────────────────────────┘    │
│                                                          │
│ 🔁 Повторение: ● Еженедельно  ○ Без повтора           │
│                                                          │
│ ⏸️ Приостановить до: [________] (опционально)         │
│                                                          │
│ [💾 Сохранить]  [❌ Отмена]                            │
└─────────────────────────────────────────────────────────┘
```

---

## 🚀 План реализации

1. ✅ Изучить текущую структуру
2. ⏳ Создать миграции БД
3. ⏳ Обновить модели SQLAlchemy
4. ⏳ Создать ReminderGenerator сервис
5. ⏳ Разработать UI компоненты
6. ⏳ Интегрировать с Telegram
7. ⏳ Тестирование

---

**Дата создания:** 10 октября 2025  
**Статус:** 📝 В разработке

